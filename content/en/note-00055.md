---
title: Container with LXC/LXD (4)
date: 2023-11-14T00:00:00+00:00
categories:
  - desktop
  - english
tags:
  - lxc
draft: true
slug: lxc-4
---

Here is a memo of me trying to use LXC/LXD on Debian 12 (`bookworm`).

This is follow-up to [Container with LXC/LXD (3)]({{<ref "note-00054.md" >}}).


## Mounting ????????

If YAML data for profile already has `raw.idmap` set as in ..., you are set.
Otherwise, you set `raw.idmap` for the running instance as:
```
 $ lxc config set dbz0 raw.idmap='both 1000 1000'
```

Also, this has `raw.idmap` entry.  This sets `raw.idmap` as a part of profile.
I will come back to this later.




<!--
LXD Containers for Wayland GUI Apps
https://blog.swwomm.com/2022/08/lxd-containers-for-wayland-gui-apps.html

---
Install any OS via ISO in a Virtual machine/VM
https://discuss.linuxcontainers.org/t/install-any-os-via-iso-in-a-virtual-machine-vm/9281
Windows VM:
Take a look at: Running virtual machines with LXD 4.0 147
or:
How to run a Windows virtual machine on LXD on Linux 141

Linux VM:

Start an empty VM with:
Note: Change VM-name to a custom name you choose.

lxc init VM-name --empty --vm

Note: In some cases it might be required to disable SecureBoot, when it blocks the .iso file (Recommendation: Disable only when necessary!).
You can do this, either by adding -c security.secureboot=false to the init/launch command
or by modifying the config key of an existing VM with: lxc config set VM-name security.secureboot=false.

Grow the VMs filesystem size:
The default size is mostly too small.
You can choose what size you think is reasonable, in this example I use 15 Gigabyte (GB).

lxc config device override VM-name root size=15GB

Add the .iso file to the VM via a disk device:
Note: Adjust the values accordingly.

lxc config device add VM-name custom-device-name disk source=/home/user/pathtoiso/isoname.iso

Start the VM with GUI:
lxc start VM-name --console=vga

--console=vga will open a VGA console.

(Note: You maybe need to install additional software for this, see GUI in Virtual Machines/VMs)

Remove disk device:
After installation you can remove the disk device, with:
lxc config device remove VM-name device-name

(optional) Convert your VM to an image:
So you can use it in the future.

lxc publish VM-name --alias custom-image-name


-----------
https://ubuntu.com/tutorials/how-to-launch-an-instantly-functional-linux-desktop-vm-with-lxd#2-initiate-an-ubuntu-desktop-vm
How to launch an instantly functional Linux desktop VM with LXD

The full command for launching an Ubuntu 22.04 VM would then look like this:

lxc launch images:ubuntu/22.04/desktop ubuntu --vm -c limits.cpu=4 -c limits.memory=4GiB --console=vga


Launching an Archlinux Desktop VM is similar to what we’ve done previously with Ubuntu, with a single addition - disabling secure boot.

The full command for launching an Archlinux VM would then look like this:

lxc launch images:archlinux/desktop-gnome archlinux --vm -c security.secureboot=false -c limits.cpu=4 -c limits.memory=4GiB --console=vga



----------

How to run Docker inside LXD containers
https://ubuntu.com/tutorials/how-to-run-docker-inside-lxd-containers#1-overview

Btrfs is one of the storage pools Docker supports natively, so we should create a new btrfs storage pool and we will call it “docker”:

lxc storage create docker btrfs

Now we can create a new LXD instance and call it “demo”:

lxc launch images:ubuntu/20.04 demo

We can proceed and create a new storage volume on the “docker” storage pool created earlier:

lxc storage volume create docker demo

We will attach it to the “demo” container and call the device being added as “docker”. Source volume is “demo” we created earlier, and we want that volume to be used for /var/lib/docker:

lxc config device add demo docker disk pool=docker source=demo path=/var/lib/docker

We need to add additional configuration so that Docker works well inside the container.

First we should allow nested containers required for Docker. Then, there are two additional security options needed - to intercept and emulate system calls. This normally wouldn’t be allowed inside LXD default unprivileged containers, but Docker relies on it for its layers, so it is okay to enable it.

lxc config set demo security.nesting=true security.syscalls.intercept.mknod=true security.syscalls.intercept.setxattr=true

To apply these changes, we need to restart the instance:

lxc restart demo




3. Install Docker
To install Docker, we start by going inside the container:

lxc exec demo bash

Now we can follow the normal Docker installation instructions. Paste the following command:

sudo apt-get update

 sudo apt-get install \
 ca-certificates \
 curl \
 gnupg \
  lsb-release
Now we need to add Docker’s official GPG key:

curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg \
--dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
And now we can install the Docker repository:

echo \
"deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \
$(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
Finally, we can install Docker itself:

sudo apt-get update
sudo apt-get install docker-ce docker-ce-cli containerd.io


4. Test your Docker container
Now we have Docker up and running. Let’s test it by running an Ubuntu Docker container:

docker run -it ubuntu bash

And we can run the following to check that the processes are running correctly:

ps aux

And that’s it! Now you have a working Ubuntu Docker container inside of an LXD container. You can use it, or you can spin up another Docker image and proceed to use it according to your needs.

5. Additional information
Vast majority of Docker images will run fine inside LXD containers. However, few might not run properly. The reason for this is that LXD runs all its container unprivileged by default, which limits some of the actions of the user. Docker, on the other hand, runs privileged containers, and some actions might expect more privileges than LXD gives them, causing potential failures. For example, if you’re running something inside a docker container that expects to run as root, it won’t be able to do actions as a real root user but rather only as root inside of the LXD container, which is more constrained.

-----
https://ubuntu.com/blog/howto-automatically-import-your-public-ssh-keys-into-lxd-instances
Just another reason why LXD is so awesome…

You can easily configure your own cloud-init configuration into your LXD instance profile.

In my case, I want cloud-init to automatically ssh-import-id kirkland, to fetch my keys from Launchpad.  Alternatively, I could use gh:dustinkirkland to fetch my keys from Github.

Here’s how!

First, edit your default LXD profile (or any other, for that matter):

$ lxc profile edit default
Then, add the config snippet, like this:

config:
  user.vendor-data: |
    #cloud-config
    users:
      - name: root
        ssh-import-id: gh:dustinkirkland
        shell: /bin/bash
description: Default LXD profile
devices:
  eth0:
    name: eth0
    nictype: bridged
    parent: lxdbr0
    type: nic
name: default
Save and quit in your interactive editor, and then launch a new instance:

$ lxc launch ubuntu:x
Creating amazed-manatee
Starting amazed-manatee
Find your instance’s IP address:

$ lxc list
+----------------+---------+----------------------+----------------------------------------------+------------+-----------+
|      NAME      |  STATE  |         IPV4         |                     IPV6                     |    TYPE    | SNAPSHOTS |
+----------------+---------+----------------------+----------------------------------------------+------------+-----------+
| amazed-manatee | RUNNING | 10.163.22.135 (eth0) | fdce:be5e:b787:f7d2:216:3eff:fe1c:773 (eth0) | PERSISTENT | 0         |
+----------------+---------+----------------------+----------------------------------------------+------------+-----------+
And now SSH in!

$ ssh ubuntu@10.163.22.135
$ ssh -6 ubuntu@fdce:be5e:b787:f7d2:216:3eff:fe1c:773
Enjoy!

:-Dustin

---------
https://ubuntu.com/blog/publishing-lxd-images
While some work remains to be done for ‘lxc publish’, the current support is sufficient to show a full cycle of image workload with lxd.

Ubuntu Wily comes with systemd by default. Sometimes you might need a Wily container with upstart. And to repeatedly reproduce some tests on Wily with upstart, you might want to create a container image.

# lxc remote add lxc images.linuxcontainers.org
# lxc launch lxc:ubuntu/wily/amd64 w1
# lxc exec w1 -- apt-get -y install upstart-bin upstart-sysv
# lxc stop w1
# lxc publish --public w1 --alias=wily-with-upstart
# lxc image copy wily-with-upstart remote:  # optional
Now you can start a new container using

# lxc launch wily-with-upstart w-test-1
# lxc exec w-test-1 -- ls -alh /sbin/init
lrwxrwxrwx 1 root root 7 May 18 10:20 /sbin/init -> upstart
# lxc exec w-test-1 run-my-tests

-------
https://www.cyberciti.biz/faq/how-to-add-or-mount-directory-in-lxd-linux-container/
How to add or mount directory in LXD (Linux container)
Author: Vivek Gite Last updated: September 18, 2023 9 comments
See all LXD related Howtos/TutorialsIhave two LXD containers running. One is for Nginx, and another is for processing data. I need to share data between two containers. How do I add or mount a shared directory between two?

One can manage devices of running containers using lxc command. To add devices such as directory to containers, use lxc config device add command. This page explains how to add a host directory to an LXD container
Tutorial details
Difficulty level	Intermediate
Root privileges	Yes
Requirements	Linux terminal
Category	LXD
Prerequisites	LXD
OS compatibility	Alma • Alpine • Arch • Debian • Fedora • Linux • Mint • openSUSE • Pop!_OS • RHEL • Rocky • Stream • SUSE • Ubuntu
Est. reading time	4 minutes

nixCraft: Privacy First, Reader Supported
nixCraft is a one-person operation. I create all the content myself, with no help from AI or ML. I keep the content accurate and up-to-date.
Your privacy is my top priority. I don’t track you, show you ads, or spam you with emails. Just pure content in the true spirit of Linux and FLOSS.
Fast and clean browsing experience. nixCraft is designed to be fast and easy to use. You won’t have to deal with pop-ups, ads, cookie banners, or other distractions.
Support independent content creators. nixCraft is a labor of love, and it’s only possible thanks to the support of our readers. If you enjoy the content, please support us on Patreon or share this page on social media or your blog. Every bit helps.
Join Patreon ➔
How add or mount directory in LXD/LXC
The procedure to mount directories in LXD as follows:

Open the terminal application
For remote LXD/Linux server login using the ssh command
To mount the host’s /wwwdata/ directory onto /var/www/html/ in the LXD container named c1, run:

lxc config device add c1 sharedwww disk source=/wwwdata/ path=/var/www/html/
Verify that directory has been mounted onto c1 container by running:

lxc exec c1 -- "ls /var/www/html"
Let us see all steps in detail for mounting directories as both in read-only and read/write mode onto containers.

Mounting your home directory in LXD (read-only)
The syntax is as follows:
lxc config device add {container-name} {name} disk source={/path/to/source/dir/} path={/path/to/dest/onto/container/}

Let us create a new container named c1:
lxc launch images:centos/8/amd64 c1
lxc list c1

Create a new directory named /dest/ onto container named c1, run:
lxc exec c1 -- "mkdir /dest/"
lxc exec c1 -- "ls -ld /dest/"

Mount your $HOME (/home/vivek/) directory onto c1 at /dest/ in read only:
lxc config device add c1 myhomedir disk source=$HOME path=/dest/

OR
lxc config device add c1 myhomedir disk source=/home/vivek/ path=/dest/

Please note that if /dest/ directory does not exist, it will be created automatically by above lxc command. Now that disk added onto c1, verify it:
lxc config device show c1

Restart the container to verify that settings remain valid:
lxc restart c1
lxc config device show c1
## login onto c1 container ##
lxc exec c1 bash
cd /dest/
ls -l
## is it read-only or read-write? ##
mkdir foo
exit

Adding a shared host directory to an LXD Container
How to remove/delete/unmount directory from an LXD container
To remove container devices such as disk named myhomedir from c1 container, run:
lxc config device remove c1 myhomedir
Device myhomedir removed from c1

Verify it:
lxc config device show c1

Add a shared host directory to an LXC/LXD container (read-write mode)
By default, the root user is not allowed to modify files inside containers from a host. It is a security feature of LXD. In other words, you need to remap your user ID if you need read-write access for mounted folders.

The subordinate gid file
Each line in /etc/subgid contains a user name and a range of subordinate group ids that user is allowed to use. This file specifies the group IDs that ordinary users can use, with the newgidmap command, to configure gid mapping in a user namespace. This is specified with three fields delimited by colons (“:). Use the cat command:
cat /etc/subgid

Sample outputs:

vivek:100000:65536
Where fields are:

vivek – Login name or UID on host
100000 – Numerical subordinate group ID
65536 – Numerical subordinate group ID count
The subordinate uid file
Again, each line in /etc/subuid contains a user name and a range of subordinate user ids that user is allowed to use. This file specifies the user IDs that ordinary users can use, with the newuidmap command, to configure uid mapping in a user namespace. To view this file, run:
cat /etc/subuid

Sample outputs:

vivek:100000:65536
How to allow LXD to remap your user ID on the host
Use the id command to find out your uid/gid:
id

Sample outputs:

uid=1000(vivek) gid=1000(vivek) groups=1000(vivek),4(adm),24(cdrom),27(sudo),30(dip),46(plugdev),115(lpadmin),116(sambashare),998(lxd)
Next, I am going to allow the LXD demon which is running as root to remap my host’s user ID inside a container:
echo "root:1000:1" | sudo tee -a /etc/subuid /etc/subgid

This is a one time set up and no need to repeat. Make sure file has been updated:
cat /etc/{subuid,subgid}

How to remap your user ID inside the container
Find UID inside the container for the user named vivek (user account must exist inside the c1):
lxc exec c1 bash
grep command '^vivek' /etc/passwd

Create a user account named if no output displayed by above grep command:
lxc exec c1 bash
adduser vivek
id vivek
exit

Type the following command to map both the UID and the GID, from the host’s UID (1000) to the c1 container’s 1000 UID (vivek):
lxc config set c1 raw.idmap "both 1000 1000"

Restart the container to settings take effect:
lxc restart c1

Finally, mount and map the directory in a read/write mode:
lxc config device add c1 myhomedir disk source=/home/vivek/ path=/home/vivek/
lxc config show c1

Test it
lxc exec c1 bash
cd /home/vivek
mkdir delta
echo "www.nixcraft.com" > test.txt
cat test.txt
rmdir delta
## back to the host ##
exit
## make sure bar.txt still exists on host ##
ls -l test.txt
cat test.txt

Linux mount directory in LXD in read and write mode
Successfully mounted hosts /home/vivek/ directory onto c1 containers in read-write mode

Conclusion
You learned how to bind-mount your Linux home directory in LXD either in read-only or read-write mode by mapping UID/GID. This feature is handy to mount high availability storage into a container. See LXD project docs for more info.


----
TO READ
https://stgraber.org/
https://stgraber.org/2017/06/15/custom-user-mappings-in-lxd-containers/
https://ubuntu.com/blog/nested-containers-in-lxd
https://ubuntu.com/blog/network-management-with-lxd-2-3
https://ubuntu.com/blog/container-to-container-networking-the-bits-have-hit-the-fan
https://ubuntu.com/blog/live-migration-in-lxd
https://ubuntu.com/blog/on-the-road-to-lean-infrastructure
https://ubuntu.com/blog/usb-hotplug-with-lxd-containers
https://ubuntu.com/blog/maas-for-the-home

















-->


<!-- vim: set sw=4 sts=4 ai si et tw=79 ft=markdown: -->
