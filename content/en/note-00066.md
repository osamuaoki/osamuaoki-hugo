---
title:  Ansible (2)
date: 2024-02-19T00:00:00+00:00
categories:
  - desktop
  - english
tags:
  - ansible
slug: ansible-2
---

Here is a series of memos of me trying to use ansible on Debian 12 (`bookworm`).

## Searching roles in Ansible Galaxy and `ansible-galaxy`

[Ansible Galaxy](https://galaxy.ansible.com/ui/) is a curation site for Ansible
scripts.  They are offered in 2 formats:

* [Roles](https://galaxy.ansible.com/ui/standalone/roles/) -- data downloaded as "`git clone ...`".
* [Collections](https://galaxy.ansible.com/ui/collections/) -- data downloaded in "`*.tar.gz`" format.

Actual data seems to be comming from github.repository.

They tend to address generic administration tasks on remote hosts and a bit
complicated.  Let me use them as examples to learn Ansible.

## Creating an initial system setup playbook

Let me expand 
[Playbook to install multiple packages (use roles)]({{< ref "note-00065.md" >}}/#playbook-to-install-multiple-packages-use-roles)
to create an initial system setup playbook.
.

### Creating a full project template with `ansible-galaxy`

Let's create a full project template with `ansible-galaxy` as:

```console
 $ cd /path/to/ansible-config-data/
 $ ansible-config init --disabled >ansible.cfg
 $ sed -i -e '/^;inventory/s/^*$/inventory=inventory.yml/' ansible.cfg
 $ cat >inventory.yml << EOF
---
all:
  hosts:
    localhost:
      ansible_connection: local
EOF
 $ ansible-galaxy init roles/base
```

This creates a source template.  Let's merge what was presented in 
[Playbook to install multiple packages (use roles)]({{< ref "note-00065.md" >}}/#playbook-to-install-multiple-packages-use-roles) to this.

```
 $ tree
.
├── README.md
├── ansible.cfg
├── inventory.yml
├── pb_main.yml
└── roles
    └── base
        ├── README.md
        ├── defaults
        │   └── main.yml
        ├── files
        ├── handlers
        │   └── main.yml
        ├── meta
        │   └── main.yml
        ├── tasks
        │   ├── install.yml
        │   ├── main.yml
        │   ├── remove.yml
        │   └── upgrade.yml
        ├── templates
        ├── tests
        │   ├── inventory
        │   └── test.yml
        └── vars
            └── main.yml
```

There are

* good old keys:`tasks`, `vars`
* some new keys: `defaults`, `handlers`, and `meta`
* some data file paths: `files`, `templates`
* test project path: `tests`

### Setup APT repository

Let's setup APT repository using deb822 format using:

* [ansible.builtin.deb822_repository module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/deb822_repository_module.html#ansible-collections-ansible-builtin-deb822-repository-module)
* [ansible.builtin.file module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/file_module.html#ansible-collections-ansible-builtin-file-module)

`apt_setup.yml`:
```
---
- name: Remove /etc/apt/sources.list
  ansible.builtin.file:
    path: /etc/apt/sources.list
    state: absent

- name: Set APT repository (debian)
  ansible.builtin.deb822_repository:
    name: debian
    types:
      - deb
      - deb-src
    uris: http://deb.debian.org/debian
    suites:
      - bookworm
      - bookworm-updates
      - bookworm-backports
    components:
      - main
      - non-free-firmware
      - contrib
      - non-free

- name: Set APT repository (debian-security)
  ansible.builtin.deb822_repository:
    name: debian-security
    types:
      - deb
      - deb-src
    uris: https://security.debian.org/debian-security/
    suites:
      - bookworm-security
    components:
      - main
      - non-free-firmware
      - contrib
      - non-free
```

### Execute shell script

** TBD **

### Copy configuration file

** TBD **

### Create directory with file module

** TBD **


<!--


[ansible.builtin.copy module – Copy files to remote locations](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/copy_module.html#ansible-collections-ansible-builtin-copy-module)
[ansible.builtin.template module – Template a file out to a target host](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/template_module.html#ansible-collections-ansible-builtin-template-module)

[ansible.builtin.shell module – Execute shell commands](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/shell_module.html#ansible-collections-ansible-builtin-shell-module)
[ansible.builtin.script module – Runs a local script on a remote node after transferring it](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/script_module.html#ansible-collections-ansible-builtin-script-module)


[ansible.builtin.apt module – Manages apt-packages](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html#ansible-collections-ansible-builtin-apt-module)

[ansible.builtin.user module – Manage user accounts](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/user_module.html#ansible-collections-ansible-builtin-user-module)
[ansible.builtin.group module – Add or remove groups](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/group_module.html#ansible-collections-ansible-builtin-group-module)

[ansible.builtin.reboot module – Reboot a machine](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/reboot_module.html#ansible-collections-ansible-builtin-reboot-module)
[ansible.builtin.systemd_service module – Manage systemd units](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/systemd_service_module.html#ansible-collections-ansible-builtin-systemd-service-module)

What's the difference between include_tasks and import_tasks
https://serverfault.com/questions/875247/whats-the-difference-between-include-tasks-and-import-tasks




Writing one big playbook in the base directory is messy.

The [playbook](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html) can be organized using:

- [Blocks](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_blocks.html) -- logical groups of tasks
- [Roles](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html) -- let you automatically load related vars, files, tasks, handlers, and other Ansible artifacts based on a known file structure.
- [Tags](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html) -- let you execute or skip selected tasks

- [Handler](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html)

Using these, the [playbook](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html) can be split into 4 types of independent files:

- variables files
- task files
- playbooks files
- roles files

"[Creating reusable files and roles](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse.html)" explains how to use these.


Selecting or skipping tags when you run a playbook

Once you have added tags to your tasks, includes, blocks, plays, roles, and
imports

, you can selectively execute or skip tasks based on their tags when you
run ansible-playbook. Ansible runs or skips all tasks with tags that match the
tags you pass at the command line. If you have added a tag at the block or play
level, with roles, or with an import, that tag applies to every task within the
block, play, role, or imported role or file. If you have a role with several
tags and you want to call subsets of the role at different times, either use it
with dynamic includes, or split the role into multiple roles.

ansible-playbook offers five tag-related command-line options:

  --tags all - run all tasks, ignore tags (default behavior)

  --tags tag1,tag2 - run only tasks with either the tag tag1 or the tag tag2

  --skip-tags tag3,tag4 - run all tasks except those with either the tag tag3 or the tag tag4

  --tags tagged - run only tasks with at least one tag

  --tags untagged - run only tasks with no tags


-->

<!--
Trace points

https://zenn.dev/y_mrok/books/ansible-no-module-no-tsukaikata
https://stackoverflow.com/questions/74869900/ansible-playbooks-install-a-list-of-apt-packages-from-a-file
https://noknowing.hatenablog.com/entry/2021/01/01/163331
https://noknowing.hatenablog.com/entry/2021/01/01/053854
https://noknowing.hatenablog.com/entry/2020/12/31/153924
https://noknowing.hatenablog.com/entry/2021/01/02/130032 docker nginx
https://knowledge.sakura.ad.jp/3116/

Similar examples referenced
https://github.com/sys0dm1n/ansible-ubuntu-desktop
https://github.com/rpthms/ansible-debian-server
https://github.com/gh640/ansible-playbook-localhost-examples

-->

<!--
vim: set sw=2 sts=2 ai si et tw=79 ft=markdown:
-->
