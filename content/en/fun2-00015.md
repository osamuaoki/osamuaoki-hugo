---
title: "Fun to Program -- Build system"
date: 2013-08-15T00:00:39+09:00
categories:
  - coding
  - english
tags:
  - fun2prog
slug: fun2prog-build
---

> This was originally written and created around 2013 and may require to be
> updated. (2021)

## Build system

There are many cross-platform build systems:

* [Autotools](#autotools) for GNU, GNOME, generic C/C++/Vala/... programs
* [CMake](/#cmake) for KDE programs, etc.
* Python `distutils` for some Python programs
    * [Install Python source distribution]({{< ref "fun2-00014.md" >}}#install-python-source-distribution) (as a user)
    * [Generate Python source distribution]({{< ref "fun2-00014.md" >}}#generate-python-source-distribution) (as an upstream)

Please note there are many programs which come with the plain GNU Make as the
build system .  The plain GNU Make is simple and works fairly well across all
modern Unix-like systems.

### Autotools

This is the most versatile and robust build system.

* [An Introduction to the Autotools](http://www.gnu.org/software/automake/manual/html_node/Autotools-Introduction.html)
    * [Introducing the GNU Build System](http://www.gnu.org/software/automake/manual/html_node/GNU-Build-System.html)
    * [Use Cases for the GNU Build System](http://www.gnu.org/software/automake/manual/html_node/Use-Cases.html)
    * [Why Autotools](http://www.gnu.org/software/automake/manual/html_node/Why-Autotools.html)
    * [A Small Hello World](http://www.gnu.org/software/automake/manual/html_node/Hello-World.html)
* [Autotools Tutorial](http://www.lrde.epita.fr/~adl/autotools.html)

The internal of Autotools are beyond my taste for learning. (Yack! What a convoluted use of [GNU m4](http://en.wikipedia.org/wiki/M4_(computer_language)) for such complicated tasks.) 

But compared to other newer build systems, I would rather use Autotools.  This is because:  "better the devil you know than the devil you don't know."

#### As a user

The source package generated by the Autotools (= Autoconf + Automake + ...)
requires only basic tools available on any Debian systems:

* Bourne shell (Dash)
* Sed
* Make

As a user, you only deal with files such as `configure` and `Makefile.in`
generated by the Autotools.  There is no need for any specialized external
tools such as GNU M4 nor Perl nor Autotools.

They can be build as follows: 

```
$ ./configure
..
$ make
..
$ sudo make install
```

The schematic relationship can be visualized as:

```
program.c --------------------------------------\
program.h --------------------------------------+--[make]--> program    
config.h.in --\                 /--> config.h --/    /
Makefile.in --+--[./configure]--+--> Makefile ------+
```

TIP: The above build process is true not just for source packages generated by
the Autotools but for many other source packages.

Here, the template files such as `Makefile.in` and `config.h.in`  have embedded
strings such as `@CC@` and `@prefix@` and they are replaced by the name of the
particular C compiler and the installation directory using the Sed program
executed from the `configure` script.  It is good idea not to mess with these
directly to customize your package build process.

Instead, you have 2 basic ways to customize your package build process as a
user.

* Run the `configure` shell script with options.
* Run the `make` command with options and environment variables.

As for the `configure` options, you get their good explanation as follows:

```
$ ./configure -h
```

You should check all available command line options displayed.  This is because
the `configure` script is meant to be run non-interactively.

As for the `make` command, since the `Makefile` generated by the Autotools
follows GNU coding standards, please read "Makefile Conventions" in the
[GNU coding standards](http://www.gnu.org/prep/standards/html_node/index.html) to
learn how to change behavior of `make`.

TIP: The default installation destination is `/usr/local`.

#### As an upstream

Autotools (= Autoconf + Automake + ...) is a tool to create the portable source
package with minimal efforts.  It is not easy to make portable across different
platforms.  It generates a good set of `configure`, `Makefile.in` and
`config.h.in` required for a source package from simple data in the
`configure.ac` and `Makefile.am` files using the `autoreconf -i` command which
runs all the Autotools in the right sequences.

```
program.c--------------+
program.h--------------+
configure.ac --+       |           +--> configure----------V
               +--[autoreconf -i]--+--> config.h.in --[./configure]--> config.h
Makefile.am  --+                   +--> Makefile.in --[./configure]--> Makefile
```

* `configure.ac` is the primarily configuration file to create `configure` by the Autoconf:
    * The Autoconf is a M4 macro program with many pre-defined macros.
    * M4 macro quotes used by the Autoconf is changed to `[` `]`.
    * M4 macro strings in `configure.ac` are substituted by the Autoconf.
    * `configure.ac` can contain shell codes and they remain in `configure` as is.
* `Makefile.am` is the primarily configuration file to create `Makefile.in` by the Automake:
    * The Automake is a Perl program.
    * `Makefile.am` defines the specific variable names and their values to denote source files and their generated files.
    * Generated build dependencies are defined as suffix rules.
    * `Makefile.am` can contain Makefile snippets and remains in `Makefile` as is.
* `Makefile` is generated from `Makefile.in` using `configure` by a user.
    * `configure` is a portable shell program.
    * `Makefile.in` is the `Makefile` template.

Suppose you have `hello.c`.


{{< snippet "examples/dist/auto/hello/hello.c" >}}

 
Then run `autoscan` to generate initial template of `configure.ac` and edit it
manually to the shape. 


{{< snippet "examples/dist/auto/autoscan.log" >}}


Since strict GNU compliance is not easy, lets make this as a "foreign" package
to avoid complication:


{{< snippet "examples/dist/auto/hello/configure.ac" >}}


`Makefile.am` defines programs to be built and relationship of source files in very simple way as.


{{< snippet "examples/dist/auto/hello/Makefile.am" >}}


Here:

* List binary program names as the value of `bin_PROGRAMS`.
* List source file names for `hello` as the value of `hello_SOURCES`.


{{< snippet "examples/dist/auto/list.log" >}}


Let's generate `configure`,  `Makefile.in` and `config.h.in` using `autoreconf
-i -v -f` (`-f` option is needed only when you are running this command second
time.  `-v` is for verbose output.):


{{< snippet "examples/dist/auto/autoreconf.log" >}}


Let's make `./configure` to change the binary program destination from
`/usr/local/bin` to `/usr/bin` and to change the entire install destination
from `/` to `./tmp` for use by the binary distribution package build.  Then
let's run it from `./tmp/usr/bin/hello`.


{{< snippet "examples/dist/auto/build.log" >}}


For more, [Using GNU Autotools](http://www.lrde.epita.fr/~adl/dl/autotools.pdf)

TIP: If you find `configure.in` instead of `configure.ac` in the source tree,
the source is very old.  It is good idea to update the configuration files to 
match newer versions of the Autotools.

TIP: You should commit only hand-edited files to the upstream VCS.  For
Autotools, these are `configure.ac`, `Makefile.am`, `*/Makefile.am`, `AUTHORS`,
and `NEWS`(optional).  Do not bother to track other generated files.

See :

* [Using GNU Autotools](http://www.lrde.epita.fr/~adl/dl/autotools.pdf)
by A. Duret-Lutz (Tutorial)
* [Introduction to the autotools (autoconf, automake, and libtool)](http://www.dwheeler.com/autotools/introduction-autotools.pdf) by David A. Wheeler (Tutorial)
* [GNU Autoconf manual (html)](http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.69/html_node/index.html), [GNU Autoconf manual (PDF)](http://www.gnu.org/savannah-checkouts/gnu/autoconf/manual/autoconf-2.69/autoconf.pdf)
* [GNU Automake manual (html)](http://www.gnu.org/software/automake/manual/automake.html), [GNU Automake manual (PDF)](http://www.gnu.org/software/automake/manual/automake.pdf)

### CMake

XXX_FIXME_XXX

* http://www.cmake.org/
* [CMake Tutorial](http://www.cmake.org/cmake/help/cmake_tutorial.html)
* Set `CMakeLists` file.


<!-- vim: set sw=2 sts=2 ai si et tw=79 ft=markdown: -->
