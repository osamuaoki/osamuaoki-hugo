---
title: "Usability tips: Backup and snapshots"
date: 2021-11-02
categories:
  - desktop
  - english
tags:
  - linux
slug: backup-1
---

## Backup and snapshot

For **backup**, data needs to be moved to physically separate device.  `rsync ...` is
my choice to do this.

For **snapshot**, data can stay on the same device .  `btrfs subvolume snapshot ...`
is my choice to do this.

I created [bss](https://github.com/osamuaoki/bss) script to help me do these easily.

## Secure backup

In order to securely backup private data using non-secure remote storage, data
needs to be encrypted.  Roughly, the following is an approach:

* create a disk image containing an encrypted filesystem
* mount the disk image un-encrypted for ease of use
    * use bind mount to offer ~/.gnupg etc.
* backup the disk image file or directory tree containing the disk image (rsync, rclone, GUI google drive)

This can be done using following tricks.

* [Making the empty disk image file](https://www.debian.org/doc/manuals/debian-reference/ch09.en.html#_making_the_empty_disk_image_file)
* [Removable disk encryption with dm-crypt/LUKS](https://www.debian.org/doc/manuals/debian-reference/ch09.en.html#_removable_disk_encryption_with_dm_crypt_luks)
* [Mounting encrypted disk with dm-crypt/LUKS](https://www.debian.org/doc/manuals/debian-reference/ch09.en.html#_mounting_encrypted_disk_with_dm_crypt_luks)
* [Expansion of usable storage space by bind-mounting another directory](https://www.debian.org/doc/manuals/debian-reference/ch09.en.html#_expansion_of_usable_storage_space_by_bind_mounting_another_directory)
* [Filesystem creation and integrity check](https://www.debian.org/doc/manuals/debian-reference/ch09.en.html#_filesystem_creation_and_integrity_check) (This is Ext4, do the same for Btrfs)

### Create and format an encrypted filesystem in a disk image

```
$ dd bs=1 count=0 if=/dev/zero of=disk.img seek=7000M
$ mkdir disk
$ cryptsetup luksFormat disk.img
WARNING: ...
 ...
$ sudo cryptsetup open disk.img disk --type luks
Enter passphrase for disk.img: *****
$ ls -l /dev/mapper
total 0
crw------- 1 root root 10, 236 Nov  3 07:45 control
lrwxrwxrwx 1 root root       7 Nov  3 12:04 disk -> ../dm-0
$ sudo mkfs.btrfs /dev/mapper/disk
 ...
   ID        SIZE  PATH
    1     6.82GiB  /dev/mapper/disk

$ sudo mount /dev/mapper/disk /mnt
$ sudo chown 1000:1000 /mnt
$ sudo umount /mnt
$ cryptsetup close disk
```

### Mount and use an encrypted filesystem in a disk image

```
$ mkdir -p ~/path/to/mnt
$ sudo cryptsetup open disk.img disk --type luks
Enter passphrase for disk.img: *****
$ sudo mount /dev/mapper/disk ~/path/to/mnt
... (use files in ~/path/to/mnt as a user)
$ sudo umount /dev/mapper/disk
$ sudo cryptsetup close disk
```

For `~/path/to/mnt`, use`~/Document`.  For `~/.gnupg`, `~/.ssh`, bind mont may
be an idea.

## Hints for LUKS and its auto-unlocking on the web

* https://access.redhat.com/solutions/230993
* https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/8/html/security_hardening/configuring-automated-unlocking-of-encrypted-volumes-using-policy-based-decryption_security-hardening
* https://dradisframework.com/support/guides/customization/auto-unlock-luks-encrypted-drive.html
* http://www.alaux.net/articles/transparent-encrypted-partition-unlocking-locking-at-login-unlogin-in-arch-linux
* https://gitlab.gnome.org/GNOME/gnome-shell/-/issues/565
* https://github.com/google/pam-cryptsetup
* https://docs.fedoraproject.org/en-US/quick-docs/encrypting-drives-using-LUKS/
* https://fedoraproject.org/wiki/Disk_Encryption_User_Guide

<!-- vim: set sw=2 sts=2 ai si et tw=79 ft=markdown: -->
