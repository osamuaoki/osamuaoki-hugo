---
title:  Automatic USB backup
date: 2024-01-02T00:00:00+00:00
categories:
  - desktop
  - english
tags:
  - linux
slug: backup-2
---

Here is a memo over automatic USB backup.

(This uses the latest `batch` subcommand of `bss`)

`udev`(7) under "RUN" clearly states "This can only be used for very
short-running foreground tasks.".

We still see old tips such as [Automatic backups with
UDEV](https://blog.deadlypenguin.com/2009/09/25/automatic-backups-with-udev/)
(2009), which abuse "RUN" in udev rule to perform backup.  These tips shouldn't
be followed.

Under modern system managed by systemd, it seems [we need to use its systemd
service file with "wants"
mechanism](https://askubuntu.com/questions/25071/how-to-run-a-script-when-a-specific-flash-drive-is-mounted/679600#679600).
(2015-2020)

## Find out systemd service name of auto mounted USB disk

Let's suppose my backup USB drive is (auto)mounted as
`/media/osamu/BKUP_USB`.  Then, I can use `systemctl list-units -t mount|grep
BKUP_USB` to find systemd service name corresponding to
`/media/osamu/BKUP_USB`.  For example:

```
$ systemctl list-units -t mount|grep USB
  media-osamu-BKUP_USB.mount      loaded active mounted /media/osamu/BKUP_USB
$ systemctl status media-osamu-BKUP_USB.mount
‚óè media-osamu-BKUP_USB.mount - /media/osamu/BKUP_USB
     Loaded: loaded (/proc/self/mountinfo)
     Active: active (mounted) since Wed 2024-01-03 20:32:41 JST; 14min ago
      Where: /media/osamu/BKUP_USB
       What: /dev/sda1
```

## Backup upon each mount event 

Create `~/.config/systemd/user/bss-BKUP_USB.service` as:
```
[Unit]
Description=USB Disk backup
Requires=media-penguin-BKUP_USB.mount
After=media-penguin-BKUP_USB.mount

[Service]
ExecStart=bss --may --type usb batch BKUP_USB

[Install]
WantedBy=media-penguin-BKUP_USB.mount
```

Create `~/.config/bss/BKUP_USB`
```
########################################################################
# make new backup copy (path are relative from $HOME)
# * source is a btrfs subvolume at ~/SRC_SUBVOL
#   * always ignore error from gather
# * destination is auto-mountable partition on a USB drive:
#   * formatted as btrfs and
#   * labeled as 'DST_LABEL'
########################################################################
bss_usb_backup () {
  # $1: SRC_SUBVOL
  # $2: DST_LABEL
  bss gather "$1" || true
  bss copy   "$1" "/media/$(id -un)/$2/$1" || $BSS_MAY
  bss snap        "/media/$(id -un)/$2/$1" || $BSS_MAY
  bss process     "/media/$(id -un)/$2/$1" || $BSS_MAY
}

# Backup to BKUP_USB (high frequency backup SSD device)
bss_usb_backup Documents BKUP_USB

# vim:se sw=2 ts=2 sts=2 et ai tw=78:
```

Then, activate this service unit as:

```sh
 $ systemctl --user enable bss-BKUP_USB.service
```

Somehow, I get the following unexpected spurious yellow warning.

```
Unit /home/penguin/.config/systemd/user/bss-BKUP_USB.service is added as a dependency to a non-existent unit media-penguin-BKUP_USB.mount.
```

Despite this warning, USB storage seems to be getting backup data when my workstation is powered up with USB drive plugged-in or when it get plugged-in.


<!--
vim: set sw=2 sts=2 ai si et tw=79 ft=markdown:
-->
