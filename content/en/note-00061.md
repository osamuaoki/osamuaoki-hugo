---
title:  Automatic USB backup
date: 2024-101-02T00:00:00+00:00
categories:
  - desktop
  - english
tags:
  - linux
slug: backup-2
---

Here is a memo over automatic USB backup.

`udev`(7) under "RUN" clearly states "This can only be used for very
short-running foreground tasks.".

We still see old tips such as [Automatic backups with
UDEV](https://blog.deadlypenguin.com/2009/09/25/automatic-backups-with-udev/)
(2009), which abuse "RUN" in udev rule to perform backup.  These tips shouldn't
be followed.

Under modern system managed by systemd, it seems [we need to use its systemd
service file with "wants"
mechanism](https://askubuntu.com/questions/25071/how-to-run-a-script-when-a-specific-flash-drive-is-mounted/679600#679600).
(2015-2020)

Followings are WIP:

## Find out systemd service name of auto mounted USB disk

Let's suppose my backup USB drive is (auto)mounted as
`/media/osamu/BKUP_USB`.  Then, I can use `systemctl list-units -t mount|grep
BKUP_USB` to find systemd service name corresponding to
`/media/osamu/BKUP_USB`.  For example:

```
$ systemctl list-units -t mount|grep USB
  media-osamu-BKUP_USB.mount      loaded active mounted /media/osamu/BKUP_USB
$ systemctl status media-osamu-BKUP_USB.mount
‚óè media-osamu-BKUP_USB.mount - /media/osamu/BKUP_USB
     Loaded: loaded (/proc/self/mountinfo)
     Active: active (mounted) since Wed 2024-01-03 20:32:41 JST; 14min ago
      Where: /media/osamu/BKUP_USB
       What: /dev/sda1
```

## Backup script


I want to run `/home/osamu/bin/backup.sh` as `osamu` using
`~/.config/systemd/USB_drive_backup.service`:

```
[Unit]
Description=USB drive backup
Requires=media-osamu-BKUP_USB.mount
After=media-osamu-BKUP_USB.mount

[Service]
ExecStart=/home/osamu/bin/backup.sh

[Install]
WantedBy=media-osamu-BKUP_USB.mount
```

This is enabled by:

```
 $ systemdctl --user enable USB_drive_backup.service
```

<!--
vim: set sw=2 sts=2 ai si et tw=79 ft=markdown:
-->
