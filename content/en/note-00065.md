---
title:  ansible (1)
date: 2024-02-17T00:00:00+00:00
categories:
  - desktop
  - english
tags:
  - ansible
slug: ansible-1
---

I realize that it is about time to getting organized for my system setup in a
way better than making notes and writing shell scripts.

I decided to deploy [Ansible](https://docs.ansible.com/) for localhost only
with CLI to help me get organized and learn Ansible.

Since upstream [Ansible documentation](https://docs.ansible.com/) address more
generic remote host usages and is too much to digest, this memo should be a
good minimal use case to get me started.  (Somehow, it is sometimes easier to
look into the Python module directory to understand how to use `ansible`.)

## Installation of Ansible

```console
$ sudo apt update
$ sudo apt install ansible ansible-lint
```

## What is Ansible

Ansible is an IT Automation Platform which uses declarative configuration file
called Playbooks.

Ansible Playbooks are lists of tasks that automatically execute for your
specified inventory.

Here:

* Inventory -- groups of hosts
* Playbook -- ordered list of play
* Play -- ordered list of tasks
* Task -- executed by associated modules written in Python

Ansible Playbook can also be a
[Rolesâ€”bundles of tasks](https://www.redhat.com/en/topics/automation/what-is-an-ansible-role).
That is addressed later.

### `ansible`(1) and `ansible-playbook`(1) CLI

Key difference of `ansible`(1) and `ansible-playbook`(1) is their target.

The `ansible`(1) command operates on `host_name_pattern` as:

```console
$ ansible host_name_pattern
 ...
```

The `ansible-playbook`(1) command operates on one or more Playbook as:

```console
$ ansible-playbook playbook1 [playbook2 ...]
 ...
```

## Create template `ansible.cfg`

Let me create template `ansible.cfg` with
[ansible-config](https://docs.ansible.com/ansible/latest/cli/ansible-config.html).

```console
$ cd /path/to/ansible-config-data/
$ ansible-config init >ansible.cfg
```

Let's keep the working directory placed on `/path/to/ansible-config-data/` from
here on.

## Create inventory with `localhost`

Update `ansible.cfg`:
```console
$ sed -i -e '/^;inventory/s/^*$/inventory=inventory.yml' ansible.cfg
```

Let's create simplest possible `inventory.yml` to define groups of hosts
on which `ansible` operates as:

```
---
all:
  hosts:
    localhost:
```

(This is `localhost` only.)

This helps to quiet "[WARNING]" when you execute following playbook examples.
It's content requirement is found in
`/usr/lib/python3/dist-packages/ansible/plugins/inventory/yaml.py` as:

- "YAML-based inventory, should start with the C(all) group and contain hosts/vars/children entries."
- Host entries can have sub-entries defined, which will be treated as variables.
- Vars entries are normal group vars.
- "Children are 'child groups', which can also have their own vars/hosts/children and so on."
- File MUST have a valid extension, defined in configuration.

## Learn to use Playbook

Let's learn playbook first with APT operation.

* [Playbook Keywords](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html)
* [ansible.builtin.apt module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html)

### Playbook to install "screen"

Here is an example playbook `pb_screen.yml` to install "screen" package.
```
---
- name: Example for ansible.builtin.apt with screen
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  tasks:
    - name: Install "screen" package
      ansible.builtin.apt:
        name: screen
        state: present
```

This playbook consists of 1 play and contains a single task definition which
uses `ansible.builtin.apt` module.

The module executable itself is written in Python.

Let's run this playbook on the localhost without "screen" package:


```console
$ ansible-playbook pb_screen.yml
PLAY [Example for ansible.builtin.apt with screen] *******************************

TASK [Install "screen" package] **************************************************
changed: [localhost]

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

So package is installed and system is changed.

### Playbook to install "screen" again

Let's run the same playbook again:

```console
$ ansible-playbook pb_screen.yml

PLAY [Example for ansible.builtin.apt with screen] *******************************

TASK [Install "screen" package] **************************************************
ok: [localhost]

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

Package is not installed and system is unchanged. This behavior is what its
[idempotency](https://docs.ansible.com/ansible/latest/reference_appendices/glossary.html#term-Idempotency)
guarantee.

### Why not to use "latest"

It's tempting to change from "present" to "latest" in this example playbook to
ensure updated version for "screen".  But it is not a good idea.  It can be
verified with [ansible-lint](https://ansible.readthedocs.io/projects/lint/):

```console
$ sed -i 's/present/latest/' pb_screen.yml
$ ansible-lint pb_screen.yml
WARNING  Listing 1 violation(s) that are fatal
package-latest: Package installs should not use latest.
pb_screen.yml:8 Task/Handler: Install "screen" package

Read documentation for instructions on how to ignore specific rule violations.

              Rule Violation Summary
 count tag            profile rule associated tags
     1 package-latest safety  idempotency

Failed after moderate profile, 2/5 star rating: 1 failure(s), 0 warning(s) on 1 files.
```

The key word is its tag "package-latest".  Its long explanation can be found
under its module directory `/usr/lib/python3/dist-packages/ansiblelint/rules`
as markdown files or on 
[Ansible Lint Documentation: Rules](https://ansible.readthedocs.io/projects/lint/rules/).

### Playbook to install multiple packages (1)


Here is another example playbook `pb_many.yml` to upgrade, install, and remove packages.
```
---
- name: Example for ansible.builtin.apt with many packages
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  tasks:
    - name: Update the whole system
      ansible.builtin.apt:
        upgrade: safe
    - name: Install packages
      ansible.builtin.apt:
        name: ["screen", "sudo"]
        state: present
    - name: Install more packages
      ansible.builtin.apt:
        name:
          - mc
          - aptitude
          - vim
        state: present
    - name: Remove packages
      ansible.builtin.apt:
        name: ["nano"]
        state: absent
```

This playbook consists of 1 play and contains 3 task definitions all of which
use `ansible.builtin.apt` module.


Here, 2 style of YAML lists are used.  Both works fine.

```console
$ ansible-playbook pb_many.yml 

PLAY [Example for ansible.builtin.apt with many packages] **********************

TASK [Update the whole system] *************************************************
ok: [localhost]

TASK [Install packages] ********************************************************
ok: [localhost]

TASK [Install more packages] ***************************************************
ok: [localhost]

TASK [Remove packages] *********************************************************
ok: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

### Playbook to install multiple packages (2)


Here is another example playbook `pb_many_vars.yml` to upgrade, install, and remove packages.
```
---
- name: Example for ansible.builtin.apt with many packages
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  vars:
    package_name:
      - screen
      - sudo
      - mc
      - aptitude
      - vim
  tasks:
    - name: Update the whole system
      ansible.builtin.apt:
        upgrade: safe
    - name: Install packages listed in package_name
      ansible.builtin.apt:
        name: "{{ package_name }}"
        state: present
    - name: Remove packages
      ansible.builtin.apt:
        name: ["nano"]
        state: absent
```

This playbook consists of 1 play and contains 1 list variable definition for
`package_name` and 3 task definitions all of which use `ansible.builtin.apt`
module.

Here,
[playbook variable](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html)
substitution.  Be careful for the use of quotation marks.

```console
$ ansible-playbook pb_many_vars.yml 

PLAY [Example for ansible.builtin.apt with many packages] **********************

TASK [Update the whole system] *************************************************
ok: [localhost]

TASK [Install packages listed in package_name] *********************************
ok: [localhost]

TASK [Remove packages] *********************************************************
ok: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

<!--

## Handler

Play component not yet touched
https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html

-->



## Ansible roles and tags

Writing one big playbook in the base directory is messy.

The [playbook](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html) can be organized using:

- [Blocks](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_blocks.html) -- logical groups of tasks
- [Roles](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html) -- let you automatically load related vars, files, tasks, handlers, and other Ansible artifacts based on a known file structure.
- [Tags](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html) -- let you execute or skip selected tasks


Using these, the [playbook](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html) can be split into 4 types of independent files:

- variables files
- task files
- playbooks files
- roles files

"[Creating reusable files and roles](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse.html)" explains how to use these.


** TBD **


<!--
Trace points

https://zenn.dev/y_mrok/books/ansible-no-module-no-tsukaikata
https://note.com/shift_tech/n/na6d914a9367b
https://stackoverflow.com/questions/74869900/ansible-playbooks-install-a-list-of-apt-packages-from-a-file


Similar examples referenced
https://github.com/sys0dm1n/ansible-ubuntu-desktop
https://github.com/rpthms/ansible-debian-server
https://github.com/gh640/ansible-playbook-localhost-examples

-->

<!--
vim: set sw=2 sts=2 ai si et tw=79 ft=markdown:
-->
