---
title:  Ansible (1)
date: 2024-02-17T00:00:00+00:00
categories:
  - desktop
  - english
tags:
  - ansible
slug: ansible-1
---

I realize that it is about time to getting organized for my system setup in a
way better than making notes and writing shell scripts.

I decided to deploy [Ansible](https://docs.ansible.com/) for localhost only
with CLI to help me get organized and learn Ansible.

Since upstream [Ansible documentation](https://docs.ansible.com/) addresses
more generic remote host usages and is too much to digest, this memo should be
a good minimal use case for me to get started.  (Somehow, it is sometimes
easier to look into the Python module directory to find and understand how to
use `ansible`.)

## Installation of Ansible

```console
$ sudo apt update
$ sudo apt install ansible ansible-lint
```

## What is Ansible

Ansible is an IT Automation Platform which uses declarative configuration file
called Playbooks.

Ansible Playbooks are lists of tasks that automatically execute for your
specified inventory.

Here:

* Inventory -- groups of hosts
* Playbook -- ordered list of play
* Play -- ordered list of tasks
* Task -- executed by associated modules written in Python

Ansible Playbook can also be a
[Roles—bundles of tasks](https://www.redhat.com/en/topics/automation/what-is-an-ansible-role).
That is addressed later.

### `ansible`(1) and `ansible-playbook`(1) CLI

Key difference of `ansible`(1) and `ansible-playbook`(1) is their target.

The `ansible`(1) command operates on `host_name_pattern` as:

```console
$ ansible host_name_pattern
 ...
```

The `ansible-playbook`(1) command operates on one or more Playbook as:

```console
$ ansible-playbook playbook1 [playbook2 ...]
 ...
```

## Create template `ansible.cfg`

Let me create template `ansible.cfg` with
[ansible-config](https://docs.ansible.com/ansible/latest/cli/ansible-config.html).

```console
$ cd /path/to/ansible-config-data/
$ ansible-config init --disabled >ansible.cfg
```

Let's keep the working directory placed on `/path/to/ansible-config-data/` from
here on.

## Create inventory with `localhost`

Update `ansible.cfg`:
```console
$ sed -i -e '/^;inventory/s/^*$/inventory=inventory.yml/' ansible.cfg
```

This creates `ansible.cfg` as (after removing non-essential comments and empty lines):

```
[defaults]
# (pathlist) Comma separated list of Ansible inventory sources
inventory=inventory.yml
```

Let's create simplest possible `inventory.yml` to define groups of hosts
on which `ansible` operates as:

```
---
all:
  hosts:
    localhost:
      ansible_connection: local
```

(This is `localhost` only and explicitly uses local connection.  When I wish to
support remote clients with ssh, I need to update this.)

This helps to quiet "[WARNING]" when you execute following playbook examples.
It's content requirement is found in
`/usr/lib/python3/dist-packages/ansible/plugins/inventory/yaml.py` as:

- "YAML-based inventory, should start with the C(all) group and contain hosts/vars/children entries."
- Host entries can have sub-entries defined, which will be treated as variables.
- Vars entries are normal group vars.
- "Children are 'child groups', which can also have their own vars/hosts/children and so on."
- File MUST have a valid extension, defined in configuration.

## Learn to use Playbook

Let's learn playbook first with APT operation.

* [Playbook Keywords](https://docs.ansible.com/ansible/latest/reference_appendices/playbooks_keywords.html)
* [ansible.builtin.apt module](https://docs.ansible.com/ansible/latest/collections/ansible/builtin/apt_module.html)

### Playbook to install "screen"

Here is an example playbook `pb_screen.yml` to install "screen" package.
```
---
- name: Example for ansible.builtin.apt with screen
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  tasks:
    - name: Install "screen" package
      ansible.builtin.apt:
        name: screen
        state: present
```

This playbook consists of 1 play and contains a single task definition which
uses `ansible.builtin.apt` module.

The module executable itself is written in Python.

Let's run this playbook on the localhost without "screen" package:


```console
$ ansible-playbook pb_screen.yml
PLAY [Example for ansible.builtin.apt with screen] *******************************

TASK [Install "screen" package] **************************************************
changed: [localhost]

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=1    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

So package is installed and system is changed.

### Playbook to install "screen" again

Let's run the same playbook again:

```console
$ ansible-playbook pb_screen.yml

PLAY [Example for ansible.builtin.apt with screen] *******************************

TASK [Install "screen" package] **************************************************
ok: [localhost]

PLAY RECAP ***********************************************************************
localhost                  : ok=1    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0

```

Package is not installed and system is unchanged. This behavior is what its
[idempotency](https://docs.ansible.com/ansible/latest/reference_appendices/glossary.html#term-Idempotency)
guarantee.

### Why not to use "latest"

It's tempting to change from "present" to "latest" in this example playbook to
ensure updated version for "screen".  But it is not a good idea.  It can be
verified with [ansible-lint](https://ansible.readthedocs.io/projects/lint/):

```console
$ sed -i 's/present/latest/' pb_screen.yml
$ ansible-lint pb_screen.yml
WARNING  Listing 1 violation(s) that are fatal
package-latest: Package installs should not use latest.
pb_screen.yml:8 Task/Handler: Install "screen" package

Read documentation for instructions on how to ignore specific rule violations.

              Rule Violation Summary
 count tag            profile rule associated tags
     1 package-latest safety  idempotency

Failed after moderate profile, 2/5 star rating: 1 failure(s), 0 warning(s) on 1 files.
```

The key word is its tag "package-latest".  Its long explanation can be found
under its module directory `/usr/lib/python3/dist-packages/ansiblelint/rules`
as markdown files or on 
[Ansible Lint Documentation: Rules](https://ansible.readthedocs.io/projects/lint/rules/).

### Playbook to install multiple packages (tasks)


Here is another example playbook `pb_many.yml` to upgrade, install, and remove packages.
```
---
- name: Example for ansible.builtin.apt with many packages
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  tasks:
    - name: Update the whole system
      ansible.builtin.apt:
        upgrade: safe
    - name: Install packages
      ansible.builtin.apt:
        name: ["screen", "sudo"]
        state: present
    - name: Install more packages
      ansible.builtin.apt:
        name:
          - mc
          - aptitude
          - vim
        state: present
    - name: Remove packages
      ansible.builtin.apt:
        name: ["nano"]
        state: absent
```

This playbook consists of 1 play and contains 3 task definitions all of which
use `ansible.builtin.apt` module.


Here, 2 style of YAML lists are used.  Both works fine.

```console
$ ansible-playbook pb_many.yml 

PLAY [Example for ansible.builtin.apt with many packages] **********************

TASK [Update the whole system] *************************************************
ok: [localhost]

TASK [Install packages] ********************************************************
ok: [localhost]

TASK [Install more packages] ***************************************************
ok: [localhost]

TASK [Remove packages] *********************************************************
ok: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=4    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

### Playbook to install multiple packages (tasks+vars)


Here is another example playbook `pb_many_vars.yml` to upgrade, install, and remove packages.

```
---
- name: Example for ansible.builtin.apt with many packages
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  vars:
    package_name_install:
      - screen
      - sudo
      - mc
      - aptitude
      - vim
    package_name_remove:
      - nano
  tasks:
    - name: Update the whole system
      ansible.builtin.apt:
        upgrade: safe
    - name: Install packages listed in package_name
      ansible.builtin.apt:
        name: "{{ package_name_install }}"
        state: present
    - name: Remove packages
      ansible.builtin.apt:
        name: "{{ package_name_remove }}"
        state: absent
```

This playbook consists of 1 play and contains 1 list variable definition for
`package_name` and 3 task definitions all of which use `ansible.builtin.apt`
module.

Here,
[playbook variable](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_variables.html)
substitution is used.  Be careful for the use of quotation marks.

```console
$ ansible-playbook pb_many_vars.yml 

PLAY [Example for ansible.builtin.apt with many packages] **********************

TASK [Update the whole system] *************************************************
ok: [localhost]

TASK [Install packages listed in package_name] *********************************
ok: [localhost]

TASK [Remove packages] *********************************************************
ok: [localhost]

PLAY RECAP *********************************************************************
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   
```

### Playbook to install multiple packages (use roles)

Although single page playbook works fine for small task, writing one big playbook in the base directory is messy.

Let's split above playbook into multiple files with `pb-main.yml` in the
base directory.

```console
 $ tree
.
├── ansible.cfg
├── inventory.yml
├── pb_main.yml
└── roles
    └── base
        ├── tasks
        │   ├── install.yml
        │   ├── main.yml
        │   ├── remove.yml
        │   └── upgrade.yml
        └── vars
            └── main.yml
```

Here in this new `pb_main.yml`:
* YAML data key for `tasks:` and `vars:` are removed.
* YAML data key `roles:` is added and it lists "base" as its component.

```
---
- name: Example for ansible.builtin.apt with many packages
  hosts: localhost
  connection: local
  gather_facts: false
  become: true
  roles:
    - base
```

Here, listed value(s) for `roles` matches the directory name under the `roles/`
directory.


Original YAML data under `tasks:` are essentially moved to
`roles/base/tasks/main.yml` using inclusion of 3 files.


`roles/base/tasks/main.yml`:
```
---
- import_tasks: upgrade.yml
- import_tasks: install.yml
- import_tasks: remove.yml
```

`roles/base/tasks/upgrade.yml`:
```
---
- name: Upgrade the whole system
  ansible.builtin.apt:
    upgrade: safe
````

`roles/base/tasks/install.yml`:
````
---
- name: Install packages listed in package_name
  ansible.builtin.apt:
    name: "{{ package_name_install }}"
    state: present
````

`roles/base/tasks/remove.yml`:
```
---
- name: Remove packages
  ansible.builtin.apt:
    name: "{{ package_name_remove }}"
    state: absent
```

Original YAML data under `vars:` are moved to `roles/base/vars/main.yml`

`roles/base/tasks/main.yml`:
```
---
# vars file

package_name_install:
  - screen
  - sudo
  - mc
  - aptitude
  - vim

package_name_remove:
  - nano
```

In the above, the entry point data file for each key such as `tasks` and `vars`
which match the parent directory name is required to use the file name `main.yml`.

```console
$ ansible-playbook pb_main.yml

PLAY [Example for ansible.builtin.apt with many packages] ***************************

TASK [base : Upgrade the whole system] **********************************************
ok: [localhost]

TASK [base : Install packages listed in package_name] *******************************
ok: [localhost]

TASK [base : Remove packages] *******************************************************
ok: [localhost]

PLAY RECAP **************************************************************************
localhost                  : ok=3    changed=0    unreachable=0    failed=0    skipped=0    rescued=0    ignored=0   

```

## Use of `ansible` command (localhost)

Let's keep the working directory still placed on
`/path/to/ansible-config-data/` from here on.


You can test modules directly from `ansible` CLI.  For example
`ansible.builtin.apt` module can be tested as:

```console
 $ ansible localhost -m ansible.builtin.apt -a "name=screen state=present"
localhost | SUCCESS => {
    "ansible_facts": {
        "discovered_interpreter_python": "/usr/bin/python3"
    },
    "cache_update_time": 1708403247,
    "cache_updated": false,
    "changed": false
}
```


<!--

## Handler

Play component not yet touched
https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_handlers.html

-->

<!--

## Ansible roles and tags

Writing one big playbook in the base directory is messy.

The [playbook](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html) can be organized using:

- [Blocks](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_blocks.html) -- logical groups of tasks
- [Roles](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse_roles.html) -- let you automatically load related vars, files, tasks, handlers, and other Ansible artifacts based on a known file structure.
- [Tags](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_tags.html) -- let you execute or skip selected tasks


Using these, the [playbook](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks.html) can be split into 4 types of independent files:

- variables files
- task files
- playbooks files
- roles files

"[Creating reusable files and roles](https://docs.ansible.com/ansible/latest/playbook_guide/playbooks_reuse.html)" explains how to use these.


** TBD **
-->

<!--
Trace points

https://zenn.dev/y_mrok/books/ansible-no-module-no-tsukaikata
https://stackoverflow.com/questions/74869900/ansible-playbooks-install-a-list-of-apt-packages-from-a-file


Similar examples referenced
https://github.com/sys0dm1n/ansible-ubuntu-desktop
https://github.com/rpthms/ansible-debian-server
https://github.com/gh640/ansible-playbook-localhost-examples

-->

<!--
vim: set sw=2 sts=2 ai si et tw=79 ft=markdown:
-->
