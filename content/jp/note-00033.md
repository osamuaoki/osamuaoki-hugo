---
title: 仮想環境(6)
date: 2021-02-13
categories:
  - virtual
  - japanese
tags:
  - lxc
slug: virt-06
---

Linux Namespaces の雰囲気が分かったところで、非特権ユーザー権限から立ち
上げられたLXC仮想環境を作ってみます。

## 非特権LXC実行環境整備

LXC (1:4.0.6-1) をBulleseye環境で`/usr/share/doc/lxc/README.Debian`の
"Unprivileged containers"に従って設定していきます。(2021/02)

まずKERNELがunprivileged user namespacesを有効にしていることを確認します。

```
$ sudo uname -a
Linux **** 5.10.0-3-amd64 #1 SMP Debian 5.10.13-1 (2021-02-06) x86_64 GNU/Linux
$ sudo sysctl kernel.unprivileged_userns_clone
kernel.unprivileged_userns_clone = 1
```
ユーザーアカウント設定の`/etc/subuid`と`/etc/subgid`はすでに設定されていました。
これらは親システムのUIDやGIDからLXCコンテナ内から見えるUIDやGIDへの対応関係定義
しています。

ネットワーク設定は以下を実行：


```
$ NAME=$(id -un)
$ sudo sh -c "echo $NAME veth lxcbr0 10 >> /etc/lxc/lxc-usernet
```

さらに、`~/.config/lxc/default.conf`のユーザー設定を`/etc/subuid`と
`/etc/subgid`に合わせて以下でします。

```
$ mkdir -p ~/.config/lxc
$ cat >~/.config/lxc/default.conf << EOF
lxc.include = /etc/lxc/default.conf
lxc.idmap = u 0 100000 65536
lxc.idmap = g 0 100000 65536
lxc.mount.auto = proc:mixed sys:ro cgroup:mixed
lxc.apparmor.profile = unconfined
EOF
```

`download` templateだけが使えるので、これを使って実行します。

```
$ lxc-create -t download -n bullseye-user -- -d debian -r bullseye -a amd64
Setting up the GPG keyring
Downloading the image index
Downloading the rootfs
Downloading the metadata
The image cache is now ready
Unpacking the rootfs

---
You just created a Debian bullseye amd64 (20210203_05:24) container.

To enable SSH, run: apt install openssh-server
No default root or user password are set by LXC.
$ cd ~/.local/share/lxc
$ tree -L 2 .
.
└── bullseye-user
    ├── config
    └── rootfs
$ cd bullseye-user
$ ls -la rootfs
otal 76
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 bin
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 boot
drwxr-xr-x  3 100000 100000 4096 Feb  3 17:08 dev
drwxr-xr-x 41 100000 100000 4096 Feb  3 17:08 etc
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 home
drwxr-xr-x 10 100000 100000 4096 Feb  3 14:26 lib
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 lib64
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 media
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 mnt
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 opt
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 proc
drwx------  2 100000 100000 4096 Feb  3 14:26 root
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 run
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 sbin
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 srv
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 sys
drwxrwxrwt  2 100000 100000 4096 Feb  3 14:26 tmp
drwxr-xr-x 11 100000 100000 4096 Feb  3 14:26 usr
drwxr-xr-x 11 100000 100000 4096 Feb  3 14:26 var
```

なるほど0(root)であるUIDやGIDが、LXCの外から見ると100000にマップされています。

ここで単純に`lxc-start`してもこけます。ここ要注意です！


**systemd-run** や **--property=Delegate=yes** が使われているのは重要です。


でも以下の様に`README.Debian`の指示どおり実行すればうまく立ち上がりました。

```
$ systemd-run --scope --quiet --user --property=Delegate=yes lxc-start -n bullseye-user
$ lxc-ls -f
NAME          STATE   AUTOSTART GROUPS IPV4       IPV6 UNPRIVILEGED
bullseye-user RUNNING 0         -      10.0.3.224 -    true
$ lxc-attach -n bullseye-user
root@bullseye-user:/#
```

GNOME terminal からの実行なので、`lxc-attach`は`systemd-run ...`をつけなくても動きました。

また、非特権LXC仮想環境でも、仮想環境の設定ファイル`config`を前記の特権LXC
仮想環境と同様に`lxc.mount.entry`の設定を追加設定することでデーター共有がで
きました。

ちなみに非特権LXCのファイルの場所は以下です。

* `~/.config/lxc/default.conf` -- 初期設定
* `~/.cache/lxc/download/debian/...`, ... -- 最初にダウンロードしたデーター
* `~/.local/share/lxc/*/` -- 各コンテナのファイルシステム (`rootfs/`, `config` を含む)
* `/run/user/1000/lxc/lock/home/osamu/.local/share/lxc` -- Lock files

## LXC仮想環境利用のTips

### Debianパッケージ作成

Debianパッケージ作成に必要なパッケージは正確にはDebian Policyで規定されています。ただ実務的には、
LXCを以下の手順で使うと、ホストシステムをsid環境にして不安定にすることなく作業がはかどります。

まず、ベースとなるsidで作成されたLXC仮想環境に以下のパッケージを導入します。 (前述の手順です)
* `build-essential`
* `devscripts`
* `debhelper`

さらに、`lxc-copy`を使い、毎回使い捨てのLXC仮想環境を準備し、その中でホストシステムと
共有されたディレクトリー内に置かれたDebianソースの`debian/control`に基づき、パッケージビルドに
必要なパッケージを追加導入します。`devscripts`パッケージに含まれる`mk-build-deps`コマンドが、
この追加導入操作に便利です。特に`-i`オプションを使うと便利です。この際、`mk-build-deps`
実行前に、最新システム環境を確保する`apt update; apt full-upgrade`を実行する
のが好ましいでしょう。

これなら、`pbuilder`等の複雑なコマンドを覚えなくとも作業がはかどります。

### Debianパッケージのデバグ

Debianパッケージのデバグの際には、毎回パッケージ依存関係確認のためにインストールするのは
無駄なので、使い捨てではなく必要な全パッケージがインストールされたLXC仮想環境を準備し、
それをベースに`lxc-copy`を使い、毎回使い捨てのLXC仮想環境を準備した方が効率的です。

PDFファイル作成に`texlive-full`等の巨大パッケージが利用される際には、この配慮は重要です。

### SSH接続

ホスト側から普通のリモートサーバー同様に操作するには、LXC仮想環境には以下のパッケージを
最低限導入するのがいい。

* コンテナ上の`openssh-server`: 公開鍵認証でパスワード無しで接続用に導入・設定します。
* コンテナ上の`sudo`: rootにsshで入れない際にsudoerにユーザーをいれ対応するために導入・設定します。
* ホスト上の`/etc/hosts`: 各LXCのIPにホスト名を定義し、アクセス操作をしやすくする。

### Python2 プログラムの実行

Debian bullseye 11 以降はPython3のみのサポートとなるので、古いPython2 プログラムを
実行しその動作を確認するには、buster環境で作成されたLXC仮想環境を準備すると便利です。


## 参考情報

* Upstream: https://linuxcontainers.org/
* Debian: `/usr/share/doc/lxc/README.Debian` (最新、重要)
* Debian: https://wiki.debian.org/LXC (slightly outdated docs)
* Ubuntu: https://ubuntu.com/server/docs/containers-lxc (semi-upstream, recent LXC 4.0)
* SUSE: https://documentation.suse.com/sles/15-SP1/html/SLES-all/part-virt-lxc.html
  (16 July 2018)

<!--

SHARE DIR: **__done__**

* https://wiki.debian.org/LXC#External_mounts_inside_the_container
* https://en.opensuse.org/User:Tsu2/LXC_mount_shared_directory

UNPREV: **__TODO__** (lxc-usernsexec関連)

* lxc-usernsexec manpage
* http://kimh.github.io/blog/buidling-btrfs-unprivileged-nested-lxc-container/
* https://askubuntu.com/questions/552543/how-to-modify-rootfs-of-an-unprivileged-lxc-container
* https://gihyo.jp/admin/serial/01/linux_containers/0017?page=2

GUI connect: **__TODO__**
https://archives.flockport.com/run-gui-apps-in-lxc-containers/

LXD:
https://ubuntu.com/blog/lxd-on-debian-using-snapd
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=768073
https://wiki.debian.org/LXD


101 Tutorial walk thru:

* LXC 2.0 walk thru https://l-w-i.net/t/lxc/0install_002.txt
* OLD hwalk thru https://medium.com/@csemanit2015/lxc-101-e31481801900

-->

<!-- vim: sw=2 sts=2 et se ai tw=79: -->
