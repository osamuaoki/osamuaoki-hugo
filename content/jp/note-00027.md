---
title: 仮想環境(2)
date: 2021-01-08
categories:
  - virtual
  - japanese
tags:
  - lxc
slug: virt-02
---

chrootを使ってのデバグ用の仮想環境作成をpbuilder/cowbuilderでと言うのは
少々強引です。とはいえ直接chrootやmountコマンドで仮想環境作成というのも
面倒です。そこで、chrootの強化版のようなLXCを使ってのデバグ用の仮想環境
作成を試みます。

ちなみに、DebianではLXDはまだパッケージされていないので、ここでは裸の
LXCのインフラを使います。

## デバグ用の仮想環境作成 (LXC)

LXCを使ってのデバグ用のsid環境の仮想環境作成を試みます。

```
 $ sudo lxc-create -n development-sid -t debian -- -r sid
```

もし、ミラーが不調なら、安定そうなUSミラーを使います。

```
 $ sudo lxc-create -n development-sid -t debian -- -r sid \\
   --mirror=http://ftp.us.debian.org
```

意外と簡単です。これで、`/var/lib/lxc/development-sid/`
以下のディレクトリーにデバグ用の `rootfs`以下にコンテナ環境の
ファイルシステムとコンテナ環境の設定ファイル`config` が
作成されます。

コンテナ環境のファイルシステム:

```
 # root@goofy:/var/lib/lxc/development-sid# tree -L 2 -F
.
├── config
└── rootfs/
    ├── bin -> usr/bin/
    ├── boot/
    ├── dev/
    ├── etc/
    ├── home/
    ├── lib -> usr/lib/
    ├── lib32 -> usr/lib32/
    ├── lib64 -> usr/lib64/
    ├── libx32 -> usr/libx32/
    ├── media/
    ├── mnt/
    ├── opt/
    ├── proc/
    ├── root/
    ├── run/
    ├── sbin -> usr/sbin/
    ├── selinux/
    ├── srv/
    ├── sys/
    ├── tmp/
    ├── usr/
    └── var/
```

コンテナ環境の設定ファイル`config`:
```
root@goofy:/var/lib/lxc/development-sid# cat config
# Template used to create this container: /usr/share/lxc/templates/lxc-debian
# Parameters passed to the template: -r sid --mirror=http://ftp.us.debian.org/debian
# For additional config options, please look at lxc.container.conf(5)

# Uncomment the following line to support nesting containers:
#lxc.include = /usr/share/lxc/config/nesting.conf
# (Be aware this has security implications)

lxc.net.0.type = veth
lxc.net.0.hwaddr = 00:16:3e:c6:d4:c8
lxc.net.0.link = lxcbr0
lxc.net.0.flags = up
lxc.apparmor.profile = generated
lxc.apparmor.allow_nesting = 1
lxc.rootfs.path = dir:/var/lib/lxc/development-sid/rootfs

# Common configuration
lxc.include = /usr/share/lxc/config/debian.common.conf

# Container specific configuration
lxc.tty.max = 4
lxc.uts.name = development-sid
lxc.arch = amd64
lxc.pty.max = 1024
```

この各設定パラメーターの意味は`lxc.conf`(5)や`lxc.container.conf`(5)や
`lxc.system.conf`(5)で確認しましょう。

## デバグ用の仮想環境のシステムとして起動 (LXC)

このデバグ用の仮想コンテナ環境をシステムとして起動します。

```
$ sudo lxc-start -n development-sid
```
上記で`lxc-start`を実行をすると、起動された仮想環境コンテナのプロセスは
daemon化してバックグラウンドで実行されつづけています。

起動された仮想環境コンテナのプロセスの状態は以下で確認できます。

```
$ sudo lxc-info -n development-sid
Name:           development-sid
State:          RUNNING
PID:            149576
IP:             10.0.3.212
Link:           vethpRy1Bk
 TX bytes:      1.18 KiB
 RX bytes:      3.20 KiB
 Total bytes:   4.39 KiB
```

この起動された仮想環境コンテナ内にシェルアクセスします。

```
$ sudo lxc-attach -n development-sid
root@development-sid:/#
```

このshellプロンプトから好きなコマンドが純粋のsid環境下で実行できます。

この仮想環境コンテナ内のshellプロセスを終了し、親システムのshellプロンプトに
戻るのは、普通に`CTRL-D`とします。

## デバグ用の仮想環境のリストや状況の確認 (LXC)

上記の`lxc-create`の実行の際に、`sid`と指定したところで、他の`testing`や`buster`等
を指定すると対応するリリースのコンテナ環境が作成できます。

システム上に作成されたアクセス可能なコンテナ環境のリストと、その情報の確認は、
親システムから以下とすると可能です。

```
$ sudo lxc-ls
development-buster  development-sid     development-testing
$ for l in `sudo lxc-ls` ; do sudo lxc-info info -n $l ; echo "----"; done
Name:           development-buster
State:          STOPPED
----
Name:           development-sid
State:          RUNNING
PID:            149576
IP:             10.0.3.212
Link:           vethpRy1Bk
 TX bytes:      1.63 KiB
 RX bytes:      4.47 KiB
 Total bytes:   6.11 KiB
----
Name:           development-testing
State:          STOPPED
----
```

ここで、３つのアクセス可能なコンテナ環境があり、その内１つが実行中(RUNNING)で
他の２つが停止中(STOPPED)です。

実は、アクセス可能なコンテナ環境の俯瞰的リストを得るだけなら、もう少し簡単に
できます。

```
$ sudo lxc-ls -f
development-buster  STOPPED 0         -      -          -    false
development-sid     RUNNING 0         -      10.0.3.212 -    false
development-testing STOPPED 0         -      -          -    false
```

ちなみに、コンテナ環境の特定の設定パラメーターの個別確認もできます。

```
$ sudo lxc-info -n development-sid -c lxc.uts.name -c lxc.rootfs.path -c lxc.rootfs.mount -c lxc.net.0.link
lxc.uts.name = development-sid
lxc.rootfs.path = /var/lib/lxc/development-sid/rootfs
lxc.rootfs.mount = /usr/lib/x86_64-linux-gnu/lxc/rootfs
lxc.net.0.link = lxcbr0
```

## 他のコンテナ環境の基本操作 (LXC)

* `lxc-stop`: コンテナ環境の停止 (`lxc-start`の逆)
* `lxc-freeze`: コンテナ環境の凍結
* `lxc-unfreeze`: コンテナ環境の凍結解除
* `lxc-destroy`: コンテナ環境の消去(`lxc-create`の逆)
* `lxc-copy`: コンテナ環境の複製
* `lxc-monitor`: コンテナ環境の監視
* `lxc-wait`: 特定コンテナ環境状態の監視待機

<!--

https://askubuntu.com/questions/610513/how-do-i-share-a-directory-between-an-lxc-container-and-the-host
https://askubuntu.com/questions/705489/allow-a-lxc-container-user-to-write-as-an-external-user-to-a-mounted-directory
https://askubuntu.com/questions/552543/how-to-modify-rootfs-of-an-unprivileged-lxc-container
https://gist.github.com/julianlam/07abef272136ea14a627
https://en.opensuse.org/User:Tsu2/LXC_mount_shared_directory
https://gihyo.jp/admin/serial/01/linux_containers/0017?page=2
https://tenforward.hatenablog.com/entry/20150522/1432294501
https://unix.stackexchange.com/questions/69072/lxc-how-do-i-mount-a-folder-from-the-host-to-the-container

lxc-usernsexec


-->


<!-- vim: sw=2 sts=2 et se ai tw=79: -->
