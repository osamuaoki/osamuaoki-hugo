---
title: PC内蔵キーボードのキーマップ操作準備
date: 2022-06-03
categories:
  - iot
  - japanese
tags:
  - evdev
slug: evdev01
---

## キーボード状況

USB接続の自作外付けキーボードでは、[キーマップ]({{< ref "note-00047.md" >}})がQMKを使うと自由に構成でき、[HOME ROW MOD](https://precondition.github.io/home-row-mods)等を使うと動きの少ない手や指にやさしいタイピングができます。

PC内蔵のキーボードででも、同じようにできないかと言う気になり色々調査しました。

[interception-tools](https://gitlab.com/interception/linux/tools)を利用し構成する可能性としてはあるようですが、まだ良い例が見当たりません。確かに`evdev`デバイスを通るデーターをフィルター変換で実現するという発想はありです。

公式のプラグインの[Dual Function Keys](https://gitlab.com/interception/linux/plugins/dual-function-keys)には、[HOME ROW MODが上手く動作しない](https://gitlab.com/interception/linux/plugins/dual-function-keys/-/issues/6)ともかかれています。状況は簡単ではないようです。

ただ、正直状況や解決策が分かりにくいので、まず読みやすいPythonの[chorded_keymap](https://gitlab.com/wsha/chorded_keymap)を見ました。実際にevdevを通るデーターの実態がよく分からなかったので、この中のプログラムをベースに[データーダンプするユーティリティー](https://github.com/osamuaoki/osamu-utils/blob/main/print_kbd_event)を作りました。

確かにほぼ同じ機能のコマンドevtestがあるんですが、この経験をしたことで少し実態が分かりました。

この出力は以下です。

```
 12577.98: MSC SCAN 0xcb / KEY LEFT → / SYN REPORT 0
 12577.996: MSC SCAN 0xcb / KEY LEFT ↑ / SYN REPORT 0
 12578.431: MSC SCAN 0xcd / KEY RIGHT ↓ / SYN REPORT 0
 12578.508: MSC SCAN 0xcd / KEY RIGHT ↑ / SYN REPORT 0
 12578.811: MSC SCAN 0xe / KEY BACKSPACE ↓ / SYN REPORT 0
 12578.878: MSC SCAN 0xe / KEY BACKSPACE ↑ / SYN REPORT 0
 12579.346: MSC SCAN 0x11 / KEY W ↓ / SYN REPORT 0
 12579.439: MSC SCAN 0x11 / KEY W ↑ / SYN REPORT 0
 12579.616: MSC SCAN 0x18 / KEY O ↓ / SYN REPORT 0
 12579.69: MSC SCAN 0x18 / KEY O ↑ / SYN REPORT 0
 12579.898: MSC SCAN 0x1c / KEY ENTER ↓ / SYN REPORT 0
 12579.976: MSC SCAN 0x1c / KEY ENTER ↑ / SYN REPORT 0
 12580.125: MSC SCAN 0x1f / KEY S ↓ / SYN REPORT 0
 12580.226: MSC SCAN 0x1f / KEY S ↑ / SYN REPORT 0
 12580.423: MSC SCAN 0x23 / KEY H ↓ / SYN REPORT 0
 12580.494: MSC SCAN 0x23 / KEY H ↑ / SYN REPORT 0
 12580.678: MSC SCAN 0x17 / KEY I ↓ / SYN REPORT 0
 12580.752: MSC SCAN 0x17 / KEY I ↑ / SYN REPORT 0
 12581.067: MSC SCAN 0x14 / KEY T ↓ / SYN REPORT 0
 12581.152: MSC SCAN 0x14 / KEY T ↑ / SYN REPORT 0
 12581.216: MSC SCAN 0x1e / KEY A ↓ / SYN REPORT 0
 12581.316: MSC SCAN 0x1e / KEY A ↑ / SYN REPORT 0
 12581.892: MSC SCAN 0x25 / KEY K ↓ / SYN REPORT 0
 12581.974: MSC SCAN 0x25 / KEY K ↑ / SYN REPORT 0
 12582.155: MSC SCAN 0x18 / KEY O ↓ / SYN REPORT 0
 12582.221: MSC SCAN 0x18 / KEY O ↑ / SYN REPORT 0
 12582.454: MSC SCAN 0x14 / KEY T ↓ / SYN REPORT 0
 12582.525: MSC SCAN 0x14 / KEY T ↑ / SYN REPORT 0
 12582.645: MSC SCAN 0x18 / KEY O ↓ / SYN REPORT 0
 12582.722: MSC SCAN 0x18 / KEY O ↑ / SYN REPORT 0
 12582.854: MSC SCAN 0x20 / KEY D ↓ / SYN REPORT 0
 12582.94: MSC SCAN 0x20 / KEY D ↑ / SYN REPORT 0
 12583.037: MSC SCAN 0x12 / KEY E ↓ / SYN REPORT 0
 12583.121: MSC SCAN 0x12 / KEY E ↑ / SYN REPORT 0
 12583.89: MSC SCAN 0x1c / KEY ENTER ↓ / SYN REPORT 0
 12584.01: MSC SCAN 0x1c / KEY ENTER ↑ / SYN REPORT 0
 12585.08: MSC SCAN 0xcd / KEY RIGHT ↓ / SYN REPORT 0
 12585.345: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0
 12585.378: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0
 12585.404: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0
 12585.436: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0
 12585.466: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0
 12585.497: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0
 12585.525: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0
 12585.555: MSC SCAN 0xcd / KEY RIGHT → / SYN REPORT 0

```
気づいたことは:
* キーを押すと、プレス(↓)となる。
* キーを長押しすると、250msぐらいで、リピート(→)となる。リピートは25ms毎ぐらい。
* キーを離すと、リリース(↑)となる。
* スキャンコードは普通使われないし、外付けキーボードではかなり違う。
* `SYN REPORT 0`のおまじないが必ずある。

これを頭に、現在出回っている、フィルターを見てみました。

HOME-ROW-MODを考えるなら、CHORDED(併せ押し)ではなく、TAP-HOLD（押しの短長）アプローチです。ただ、それも[caps2esc](https://gitlab.com/interception/linux/plugins/caps2esc)等は、press=HOLDで、RELEASEでタイミングが200ms以下ならTAPを出す感じです。CAPSのような端のキーならまだしも、HOME-ROW-MODでこれをするとまともにタイプできません。

TAP-HOLD時間判断はプログラム内で管理が必要かと思っていましたが、あまりフィルターで使われていないリピート(→)を上手く利用すると複雑なEVENT処理をし無くとも実現できそうな気がします。

[Dual Function Keys](https://gitlab.com/interception/linux/plugins/dual-function-keys)は、基本イベント処理ループは`C`で書かれていて、YAML設定ファイルは`C++`で読み込んでいます。別にタイミングチャート図が有り参考になります。TAP-HOLDのスタートや他キーが早くPUSH・RELEASEされた際の対応はいい感じです。他にキー打鍵無い際のHOLD移行にタイマーかREPEATを使わないようなのは気になります。またこれが使うTAP-HOLDのルールーは上記の[HOME-ROW-MODで問題](https://gitlab.com/interception/linux/plugins/dual-function-keys/-/issues/6)があるようです。

[Interception plugin for vimproved input](https://github.com/maricn/interception-vimproved) は、`C++`で書かれていて、汎用性は無い形ですがレイヤー処理があります。(SPACE-fn)

[interception-k2k](https://github.com/zsugabubus/interception-k2k)は、基本イベント処理ループは`C`で書かれていて、設定ファイルはincludeファイルを使う汎用マッパーです。レイヤー機能はありません。設定ファイルがCですが、見通しがいいスタイルですね。REPEATにも対応してそうです。
(Makefileのターゲットの前提要件中に`|`を使ってORDER-ONLY-PREREQUISITESを規定するのははじめてみたので、ちょっとと惑いました。)

## キーボードのTAP-HOLDタイミング考察

TAP-HOLDの無いキーをそのまま通過させるとすると、キーボードのTAP-HOLDタイミングは、HOME-ROW-MODでは、端のキーでは望ましそうなimmediateタイプではなく、delayedタイプが必要な気がします。

 * immediate: immediate hold (capslock用)
 * delayed:   immediate pending state for the key (wait for B↑ or A→) (HOME-ROW-MOD用)

キータイミング図で、それぞれのあるべき動作を確認します。

### 単一MT キーを使用時のタイミング図

```
A: as MT(KC_SHFT, KC_A)
  S: KC_SHFT
  A: KC_A

----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓             A↑

immediate:      S↓             S↑A↓A↑
delayed:        ??               A↓A↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                        A→        A↑

immediate:      S↓                                  S↑
delayed:        ??                        S↓        S↑
----------------------------------------------------------------------------------
```

### MTキーと普通キーを使用時のタイミング図


```
A: as MT(KC_SHFT, KC_A)
  S: KC_SHFT
  A: KC_A
B: simple key　TAP無処理の場合 (TAP処理するなら、次のセクションのMT(KC_CTRL, KC_B)と同じ)

----------------------------------------------------------------------------------
                <---------200ms---------> (高速タイプ対策上必要)
keyboard1:      A↓             A↑
keyboard2:         B↓ B↑

immediate:      S↓ B↓ B↑       S↑       (Aタップ扱いしない処理が必要)
delayed:        ?? B↓ B↑       S↑       (Aタップ扱いしない処理が必要)
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms---------> (逆順はMTキーの必然)
keyboard1:      A↓             A↑
keyboard2:                B↓             B↑

immediate:      S↓        B↓   S↑A↓A↑    B↑    (シフト問題：HOME-ROW-MODで問題)
delayed:        ??        B↓   A↓A↑      B↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→          A↑
keyboard2:         B↓ B↑

immediate:      S↓ B↓ B↑                            S↑
delayed:        ?? B↓ B↑                S↓          S↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→            A↑
keyboard2:                          B↓         B↑

immediate:      S↓                  B↓         B↑     S↑
delayed:        ??                  B↓  S↓     B↑     S↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→            A↑
keyboard2:                                   B↓  B↑

immediate:      S↓                           B↓  B↑   S↑
delayed:        ??                      S↓   B↓  B↑   S↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→          A↑
keyboard2:                                   B↓          B↑

immediate:      S↓                           B↓     S↑   B↑
delayed:        ??                      S↓   B↓     S↑   B↑
----------------------------------------------------------------------------------
```

### MTキー同士の組み合わせ使用時のタイミング図

```
A: as MT(KC_SHFT, KC_A)
  S: KC_SHFT
  A: KC_A
B: as MT(KC_CTRL, KC_B)
  C: KC_CTRL
  B: KC_B
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓             A↑
keyboard2:         B↓ B↑

immediate:      S↓    B↓B↑     S↑       (Aタップ扱いしない処理が必要)
delayed:        ?? ** S↓B↓B↑   S↑       (Aタップ扱いしない処理が必要)
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms---------> (逆順はMTキー同士では発生しない)
keyboard1:      A↓             A↑
keyboard2:                B↓             B↑

immediate:      S↓        **   S↑A↓A↑    B↓B↑ (シフト問題なし)
delayed:        ??        **   A↓A↑      B↓B↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→          A↑
keyboard2:         B↓ B↑

immediate:      S↓    B↓B↑                          S↑
delayed:        ?? ** S↓B↓B↑                        S↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→          A↑
keyboard2:                          B↓         B↑

immediate:      S↓                             B↓B↑ S↑
delayed:        ??                  **  S↓     B↓B↑ S↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→            A↑
keyboard2:                                   B↓  B↑

immediate:      S↓                               B↓B↑ S↑
delayed:        ??                      S↓       B↓B↑ S↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
keyboard1:      A↓                      A→          A↑
keyboard2:                                   B↓            B↑

immediate:      S↓                                         B↓S↑B↑
delayed:        ??                      S↓   **            B↓S↑B↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
                                     <---------200ms--------->
keyboard1:      A↓                      A→          A↑
keyboard2:                          B↓                       B→        B↑

immediate:      S↓                  ??              S↑       C↓        C↑
delayed:        ??                  **  S↓          S↑       C↓        C↑
----------------------------------------------------------------------------------
----------------------------------------------------------------------------------
                <---------200ms--------->
                                     <---------200ms--------->
keyboard1:      A↓                      A→                       A→           A↑
keyboard2:                          B↓                       B→        B↑

immediate:      S↓                  ??                       C↓        C↑     S↑
delayed:        ??                  **  S↓                   C↓        C↑     S↑
----------------------------------------------------------------------------------
```

<!-- vim: se ai tw=150: -->
