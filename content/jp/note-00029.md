---
title: 仮想環境(3)
date: 2021-01-28
categories:
  - virtual
  - japanese
tags:
  - lxc
slug: virt-03
---

引き続きchrootの強化版のようなLXCを使っての仮想環境作成を深堀りします。

## LXC仮想環境の停止

仮想環境のカスタマイズした起動をするためには、作成し起動した仮想環境の`STATE`を
`STOPPED`(停止)に確実にします。

```
$ sudo lxc-stop -n sid
$ sudo lxc-ls -f
NAME   STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
buster STOPPED 0         -      -    -    false
sid    STOPPED 0         -      -    -    false
```

## LXC仮想環境とのデーター共有起動

仮想環境のカスタマイズした起動時に、設定変数を指定することで、ホスト側の
`/home/fish/src`を仮想環境内の`/home/fish`としてアクセスできるように共有化
された仮想環境として起動できます。この仮想環境環境にユーザーアカウントに
ログインするまでの手順は以下です。

```
$ sudo lxc-start -n sid \
  -s "lxc.mount.entry=/home/fish/src home/fish none bind 0 0"
$ sudo lxc-attach -n sid
root@sid:/# login
sid login: fish
Password:
 ...
fish@sid:~$
```
ここで仮想環境内のホームディレクトリーで見えるのは`/home/fish/src`と同一デバイス上の
ファイルだけです。(再帰的マウントはされません。)

このLXC仮想環境内でパッケージビルドなどをすれば綺麗な環境ででき、さらにその結果に
ホスト側から直接アクセスできます。

ここでは、`lxc-attach`+`login`でユーザーアカウントに入っていますが、`lxc-console`を
使っても良いです.

## LXC仮想環境とのデーター共有設定

立ち上げ毎に長い`-s`オプションを使ってのbindマウント指定をなくするには、`lxc-create`
コマンドが作った基本の仮想環境の設定ファイル`config`を編集し、設定します。
```
# cd /var/lib/lxc/sid
# cp config config.orig
# vim config
 ...
# diff -u config.orig config
--- config.orig	2021-01-29 09:34:50.520450872 +0900
+++ config	2021-01-29 00:30:53.868368439 +0900
@@ -13,6 +13,7 @@
 lxc.apparmor.profile = generated
 lxc.apparmor.allow_nesting = 1
 lxc.rootfs.path = dir:/var/lib/lxc/sid/rootfs
+lxc.mount.entry=/home/fish/src/public home/fish/mnt none bind 0 0

 # Common configuration
 lxc.include = /usr/share/lxc/config/debian.common.conf
```
これでホスト側の`/home/fish/src`を仮想環境内の`/home/fish`としてアクセス
できるように共有化した仮想環境として立ち上げが、単純な以下の操作でできる
ようになります。

```
$ sudo lxc-start -n sid
```

## 使い捨てのLXC仮想環境

`pbuilder`でコアのシステム環境のコピーをベースにした使い捨ての仮想環境をchrootで準備し
パッケージを作成するように、LXCででもコアのシステム環境のコピーをベースにした使い捨ての
仮想環境を準備してみましょう。

これには、`lxc-start`に代え`lxc-copy`を`-e`フラグとともに使います。(聞きなれない
"ephemeral"という表現は「儚い」「束の間であっけない」と言うことです。)

`lxc-copy`には`lxc-start`の`-s`オプションのような機能がないので、仮想環境とのデーター
共有を実現するには、コピー元の仮想環境の設定ファイル`config`を上記のように編集し
`lxc.mount.entry`を追加設定しておく必要があります。

```
$ sudo lxc-stop -n sid
$ sudo lxc-info -n sid
Name:           sid
State:          STOPPED
$ sudo lxc-copy -n sid -N sid-dev01 -e
Created sid-dev01 as clone of sid
$ sudo lxc-ls -f
NAME      STATE   AUTOSTART GROUPS IPV4       IPV6 UNPRIVILEGED
buster    STOPPED 0         -      -          -    false
sid       STOPPED 0         -      -          -    false
sid-dev01 RUNNING 0         -      10.0.3.220 -    false
```

`lxc-copy`で使い捨てのLXC仮想環境を起動をするには、実行前にコピー元の仮想環境の`STATE`を
`STOPPED`(停止)に確実にする必要があります。

こうして作った使い捨てのLXC仮想環境は、`lxc-attach`か`lxc-console`で入り利用できます。

さらに、利用後の使い捨てのLXC仮想環境は、`lxc-stop`とするだけで`lxc-destroy`すること無く
消滅するので、開発ホストシステム中のゴミファイルの蓄積を防げます。

```
$ sudo lxc-stop sid-dev01
$ sudo lxc-ls -f
NAME   STATE   AUTOSTART GROUPS IPV4 IPV6 UNPRIVILEGED
buster STOPPED 0         -      -    -    false
sid    STOPPED 0         -      -    -    false
```

## 非特権LXC実行環境整備

LXC (1:4.0.6-1) をBulleseye環境で`/usr/share/doc/lxc/README.Debian`の
"Unprivileged containers"に従って設定していきます。(2021/02)

まずKERNELがunprivileged user namespacesを有効にしていることを確認します。

```
$ sudo uname -a
Linux **** 5.10.0-2-amd64 #1 SMP Debian 5.10.9-1 (2021-01-20) x86_64 GNU/Linux
$ sudo sysctl kernel.unprivileged_userns_clone
kernel.unprivileged_userns_clone = 1
```
ユーザーアカウント設定の`/etc/subuid`と`/etc/subgid`はすでに設定されていました。

ネットワーク設定は以下を実行：


```
$ NAME=$(id -un)
$ sudo sh -c "echo $NAME veth lxcbr0 10 >> /etc/lxc/lxc-usernet
```

さらに、`~/.config/lxc/default.conf`のユーザー設定を`/etc/subuid`と
`/etc/subgid`に合わせて以下でします。

```
$ mkdir -p ~/.config/lxc
$ cat >~/.config/lxc/default.conf << EOF
lxc.include = /etc/lxc/default.conf
lxc.idmap = u 0 100000 65536
lxc.idmap = g 0 100000 65536
lxc.mount.auto = proc:mixed sys:ro cgroup:mixed
lxc.apparmor.profile = unconfined
EOF
```

`download` templateだけが使えるので実行します。

```
$ lxc-create -t download -n bullseye-user -- -d debian -r bullseye -a amd64
Setting up the GPG keyring
Downloading the image index
Downloading the rootfs
Downloading the metadata
The image cache is now ready
Unpacking the rootfs

---
You just created a Debian bullseye amd64 (20210203_05:24) container.

To enable SSH, run: apt install openssh-server
No default root or user password are set by LXC.
$ cd ~/.local/share/lxc
$ tree -L 2 .
.
└── bullseye-user
    ├── config
    └── rootfs
$ cd bullseye-user
$ ls -la rootfs
otal 76
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 bin
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 boot
drwxr-xr-x  3 100000 100000 4096 Feb  3 17:08 dev
drwxr-xr-x 41 100000 100000 4096 Feb  3 17:08 etc
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 home
drwxr-xr-x 10 100000 100000 4096 Feb  3 14:26 lib
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 lib64
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 media
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 mnt
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 opt
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 proc
drwx------  2 100000 100000 4096 Feb  3 14:26 root
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 run
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 sbin
drwxr-xr-x  2 100000 100000 4096 Feb  3 14:26 srv
drwxr-xr-x  2 100000 100000 4096 Jul  9  2019 sys
drwxrwxrwt  2 100000 100000 4096 Feb  3 14:26 tmp
drwxr-xr-x 11 100000 100000 4096 Feb  3 14:26 usr
drwxr-xr-x 11 100000 100000 4096 Feb  3 14:26 var
```

なるほどUIDやGIDがマップされています。

ここで単純にlxc-startしてもこけますが、`README.Debian`の指示どおり以下を実行すれば
うまく立ち上がりました。

```
$ systemd-run --scope --quiet --user --property=Delegate=yes lxc-start -n bullseye-user
$ lxc-ls -f
NAME          STATE   AUTOSTART GROUPS IPV4       IPV6 UNPRIVILEGED
bullseye-user RUNNING 0         -      10.0.3.224 -    true
$ lxc-attach -n bullseye-user
root@bullseye-user:/#
```

GNOME terminal からの実行なので、`lxc-attach`は`systemd-run ...`
をつけなくても動きました。

また、非特権LXC仮想環境でも、仮想環境の設定ファイル`config`を前記の特権LXC
仮想環境と同様に`lxc.mount.entry`の設定を追加設定することでデーター共有がで
きました。


## LXC仮想環境利用のTips

### Debianパッケージ作成

Debianパッケージ作成に必要なパッケージは正確にはDebian Policyで規定されています。ただ実務的には、
LXCを以下の手順で使うと、ホストシステムをsid環境にして不安定にすることなく作業がはかどります。

まず、ベースとなるsidで作成されたLXC仮想環境に以下のパッケージを導入します。 (前述の手順です)
* `build-essential`
* `devscripts`
* `debhelper`

さらに、`lxc-copy`を使い、毎回使い捨てのLXC仮想環境を準備し、その中でホストシステムと
共有されたディレクトリー内に置かれたDebianソースの`debian/control`に基づき、パッケージビルドに
必要なパッケージを追加導入します。`devscripts`パッケージに含まれる`mk-build-deps`コマンドが、
この追加導入操作に便利です。特に`-i`オプションを使うと便利です。この際、`mk-build-deps`
実行前に、最新システム環境を確保する`apt update; apt full-upgrade`を実行する
のが好ましいでしょう。

これなら、`pbuilder`等の複雑なコマンドを覚えなくとも作業がはかどります。

### Debianパッケージのデバグ

Debianパッケージのデバグの際には、毎回パッケージ依存関係確認のためにインストールするのは
無駄なので、使い捨てではなく必要な全パッケージがインストールされたLXC仮想環境を準備し、
それをベースに`lxc-copy`を使い、毎回使い捨てのLXC仮想環境を準備した方が効率的です。

PDFファイル作成に`texlive-full`等の巨大パッケージが利用される際には、この配慮は重要です。

### SSH接続

ホスト側から普通のリモートサーバー同様に操作するには、LXC仮想環境には以下のパッケージを
最低限導入するのがいい。

* コンテナ上の`openssh-server`: 公開鍵認証でパスワード無しで接続用に導入・設定します。
* コンテナ上の`sudo`: rootにsshで入れない際にsudoerにユーザーをいれ対応するために導入・設定します。
* ホスト上の`/etc/hosts`: 各LXCのIPにホスト名を定義し、アクセス操作をしやすくする。

### Python2 プログラムの実行

Debian bullseye 11 以降はPython3のみのサポートとなるので、古いPython2 プログラムを
実行しその動作を確認するには、buster環境で作成されたLXC仮想環境を準備すると便利です。


## 参考情報

* Upstream: https://linuxcontainers.org/
* Debian: `/usr/share/doc/lxc/README.Debian` (最新、重要)
* Debian: https://wiki.debian.org/LXC (slightly outdated docs)
* Ubuntu: https://ubuntu.com/server/docs/containers-lxc (semi-upstream, recent LXC 4.0)
* SUSE: https://documentation.suse.com/sles/15-SP1/html/SLES-all/part-virt-lxc.html
  (16 July 2018)

<!--

SHARE DIR: **__done__**

* https://wiki.debian.org/LXC#External_mounts_inside_the_container
* https://en.opensuse.org/User:Tsu2/LXC_mount_shared_directory

UNPREV: **__TODO__** (lxc-usernsexec関連)

* lxc-usernsexec manpage
* http://kimh.github.io/blog/buidling-btrfs-unprivileged-nested-lxc-container/
* https://askubuntu.com/questions/552543/how-to-modify-rootfs-of-an-unprivileged-lxc-container
* https://gihyo.jp/admin/serial/01/linux_containers/0017?page=2

GUI connect: **__TODO__**
https://archives.flockport.com/run-gui-apps-in-lxc-containers/

LXD:
https://ubuntu.com/blog/lxd-on-debian-using-snapd
https://bugs.debian.org/cgi-bin/bugreport.cgi?bug=768073
https://wiki.debian.org/LXD


101 Tutorial walk thru:

* LXC 2.0 walk thru https://l-w-i.net/t/lxc/0install_002.txt
* OLD hwalk thru https://medium.com/@csemanit2015/lxc-101-e31481801900

-->

<!-- vim: sw=2 sts=2 et se ai tw=79: -->
