---
title: 仮想環境(3)
date: 2021-01-27
categories:
  - virtual
  - japanese
tags:
  - lxc
slug: virt-03
---

chrootの強化版のようなLXCを使ってのデバグ用の仮想環境作成をさらに
深堀りします。

## 仮想環境とのデーター共有 (LXC)

仮想環境内(`development-sid`)にホスト側で通常ログインしているのと同じ
uid=1000のユーザーを作成します。

```
$ sudo lxc-start -n development-sid
$ sudo lxc-ls -f
NAME                STATE   AUTOSTART GROUPS IPV4       IPV6 UNPRIVILEGED
development-buster  STOPPED 0         -      -          -    false
development-sid     RUNNING 0         -      10.0.3.212 -    false
development-testing STOPPED 0         -      -          -    false
$ sudo lxc-attach -n development-sid
```
このユーザーを`fish`とし、仮想環境内に同一ユーザーアカウントを作成し
基本開発環境を作成し、ログアウトします。
```
root@development-sid:/# adduser -uid 1000 fish
 ...
root@development-sid:/# apt-get update
 ...
root@development-sid:/# apt-get install mc vim nano- aptitude devscripts
 ...
root@development-sid:/home/fish/# ^D
```

仮想環境内にインストールされるパッケージは上記でログアウトする前に追加操作
することでカスタマイズ自在に設定できます。

さて、一旦作成した仮想環境を停止し、ホスト側の`/home/fish/src`を仮想環境内の
`/home/fish`としてアクセスできるように共有化した仮想環境として再立ち上げ、
この仮想環境環境にログインします。

```
$ sudo lxc-stop -n development-sid
$ sudo lxc-start -n development-sid \
  -s "lxc.mount.entry=/home/fish/src home/fish none bind 0 0"
$ sudo lxc-attach -n development-sid
root@development-sid:/#
```
各種操作をこのまま続けても良いのですが、ホスト側の`/home/fish/src`から見ると
ルート所有ファイルができて面倒です。そこで仮想環境内の対応する非ルートユーザー
にログインし操作します。

```
root@development-sid:/# login
development-sid login: fish
Password:
Linux development-sid 5.10.0-1-amd64 #1 SMP Debian 5.10.4-1 (2020-12-31) x86_64

The programs included with the Debian GNU/Linux system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Debian GNU/Linux comes with ABSOLUTELY NO WARRANTY, to the extent
permitted by applicable law.
Last login: Wed Jan 27 11:33:27 UTC 2021 on pts/5
samu@development-sid:~$
...
```

ここで仮想環境内のホームディレクトリーで見えるのは`/home/fish/src`と同一デバイス上の
ファイルだけです。(再帰的マウントはされません。)

この状態でパッケージビルドなどをすれば綺麗な環境でできます。

## 使い捨ての仮想環境 (LXC)

`pbuilder`でコアのシステム環境のコピーをベースにした使い捨ての仮想環境をcherootで準備するように、
LXCででもコアのシステム環境のコピーをベースにした使い捨ての仮想環境を準備するには、
`lxc-copy`を`-e`フラグとともに使うようです。ここで聞きなれない"ephemeral"というのは「儚い」
「束の間であっけない」と言うことです。

上述のような仮想環境とのデーター共有をコピーし作成した使い捨ての環境で実現するには
`lxc-start`でバインドマウントしてシステム環境を立ち上げる代わりに`lxc-copy`を用いて
`-e -m bind=/home/fish/src:/home/fish:rw`等として使い捨ての仮想環境を立ち上げればいいようです。

XXX FIXME XXX 上記は要確認


## 参考情報

* https://linuxcontainers.org/
* https://wiki.debian.org/LXC

<!--
lxc-usernsexec
-->


<!-- vim: sw=2 sts=2 et se ai tw=79: -->
