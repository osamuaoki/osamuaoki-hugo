---
title: STM32F411CE (1)
date: 2022-02-07
categories:
  - iot
  - japanese
tags:
  - blackpill
slug: blackpill-1
---

基本のSTM32F系の安価だけど、純正STMチップ(同等品でない)が載っていそうな
小型のデモボードとして、WeActのblackpillをAliexpressの正規ショップ
から購入しました。STM32F411CEが載っています。

* WeActのデバイス情報 https://github.com/WeActTC/MiniSTM32F4x1

## PCB回路要点

| IC PIN | 機能    | 動作 |
|--------|---------|------------------------------|
| 7      | NRST    | RESET SW, PUSH=0 , NORMAL=1  |
| 44     | BOOT0   | BOOT SW, PUSH=1, NORMAL=0    |
| 20     | PB2 / BOOT1 | NORMAL=0 (pull down res.)    |
| 10     | PA0 / WKUP1 | USER KEY, NORMAL=1, PUSH=0   |
| 2      | PC13 /   | BLUE LED, LED_ON=0

## STM32のメモリー

* `0x0000 0000 - 0x0007 FFFF` (REMAPされる) -- The code area
    * 通常 BOOT0は押されていないので: Flash memoryをさしている
        * つまりユーザー作成のFirmware実行
    * BOOT0 pushed: System memory (BOOT0 pushed)
        * CU内臓のBOOTLOADERの実行, STM32F411の場合はUSB経由のDFUもサポート
* `0x2000 0000 - 0x2002 0000` SRAM1 (128 KB) -- The data area
* `0x0800 0000 - 0x0807 FFFF` Flash memory Flash memory (512KB)
* `0x1FFF 0000 - 0x1FFF 77FF` System memory (32MB)

STM32F103等だと、NativeでDFUをサポートしていなかったので、シリアル接続などでFlash
memory内に小さめのHIDのBOOTLOADERを入れることがよく行われていたようだが、
互換性を求めないならDFUで充分と見ました。

### 起動

* the CPU fetches the top-of-stack value from address 0x0000 0000,
* the CPU  starts code execution from the boot memory starting from 0x0000 0004.

### リセットのモード

STM32F411xx は のBOOTMODEはPattern1で起動する。つまり、BOOTMODE実行条件は：
* `Boot0(pin) = 1` (BOOT SW, PUSHed)
* `Boot1(pin) = 0` (Blackpillデフォルト

つまり、REMAPを使い
* RESETだけを押すと、`Boot0(pin)=0`なので、Main Flash memory を実行。
* RESETとBOOT0 を押すと、`Boot0(pin)=1`なので、System memory を実行。

### Standbyからの起動

`PA0 / WKUP1` が `0->`1 でwakeup　（つまり、USERのSWを離した時点）


## PIN OUT


```
Blackpill (TOP VIEW)

                              USB-C
                        +---+-----+---+
        R0  ------- B12 |*  |     |  *|5V
        R1  ------- B13 |*  |     |  *|GND ----- JS_GND
        R2  ------- B14 |*  |     |  *|3V3 ----- JS_V
        R3  ------- B15 |*  +-----+  *|B10
        C6  ------- A8  |*  B     N  @|B2 --- BOOT1
                XXX A9  |*  O     R  @|B1 XXX
                XXX A10 |*  O     S  @|B0 XXX
                XXX A11 |*  T     T  *|A7 XXX
        C5  ------- A12 |*  0        *|A6 XXX
        C4  ------- A15 |*           *|A5 ------ JS_R1
        C3  ------- B3  |*           *|A4 ------ JS_R2
        C2  ------- B4  |*           *|A3 ------ C7
        C1  ------- B5  |*           *|A2 ------ C8
        C0  ------- B6  |*           *|A1 ------ C9
        C11 ------- B7  |*           *|A0 ------ C10
                    B8  |*  K        *|R ---- NRST (/RST, ~RST)
                    B9  |*  E        *|C15 ----- C12
                    5V  |*  Y        *|C14 ----- C13
                    GND |*           *|C13 -- BLUE LED
                    3V3 |*  @ @ @ @  *|VB
                        +-------------+
                            ^ ^ ^ ^
                            | | | |
      3V3    ---------------+ | | |
    SWDIO    -----------PA13--+ | |
    SWSCK    -----------PA14----+ |
      GND    ---------------------+
```

XXX PINs had mechanical interferences
A0-B1 can be used for ADC (A4, B5 for joystick)
Avoid pins used internally and for DIO
/

## FACTORY SETTING

とりあえず、PCに繋いでみました。

```
 $ journalctl -f
...
... usb 4-2: new full-speed USB device number 13 using xhci_hcd
... usb 4-2: config 1 interface 0 altsetting 0 endpoint 0x81 has an invalid bInterval 0, changing to 10
... usb 4-2: config 1 interface 0 altsetting 0 endpoint 0x1 has an invalid bInterval 0, changing to 10
... usb 4-2: New USB device found, idVendor=0483, idProduct=572a, bcdDevice= 2.00
... usb 4-2: New USB device strings: Mfr=1, Product=2, SerialNumber=3
... usb 4-2: Product: WeAct Studio HID Bootloader
... usb 4-2: Manufacturer: WeAct Studio
... usb 4-2: SerialNumber: ************
... hid-generic 0003:0483:572A.001A: hiddev1,hidraw1: USB HID v1.11 Device [WeAct Studio WeAct Studio HID Bootloader] on usb-0000:08:00.3-2/input0
... checking bus 4, device 13: "/sys/devices/pci0000:00/0000:00:08.1/0000:08:00.3/usb4/4-2"
... bus: 4, device: 13 was not an MTP device
... checking bus 4, device 13: "/sys/devices/pci0000:00/0000:00:08.1/0000:08:00.3/usb4/4-2"
... bus: 4, device: 13 was not an MTP device
```

どうも、FLASHにはすでにHIDのBOOTLOADERがすでに入っている模様です。

さて、FIRMWAREを書かないと。

<!-- vim: se ai tw=79: -->

