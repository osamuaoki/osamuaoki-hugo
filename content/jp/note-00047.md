---
title: QMK (4) -- キーマップ改善 (タップとホールドの有効利用)
date: 2022-03-15
categories:
  - iot
  - japanese
tags:
  - qmk
slug: home-mt
---

## 状況

QMKを使う[cgc56やcgg56というQMKを利用したキーボード](https://github.com/osamuaoki/cg56)等を使って、色々試して気づいたり考えたことを以下に記します。

* メンタルストレス無く、フィジカルストレスの小さい指の動きが少ないキーマップが欲しい。
  * 親指がカバーするのは、横に並ぶ２キーが望ましい (英語専用なら１つでも可能は可能。動きとしては３つまでは可能だが、PCBが大きくなる)
  * 人差し指は縦の動きで２列カバーする。
  * 他の指は縦１列の動き以外はしない。
  * 「QWERTY」は当分メインのキーマップのベース。
  * 「QWFRTY」はローマ字入力用オプションの検討中キーマップ。
* 高速打鍵性自体は私の目指す所では無い。
* キーのピッチをきっちり確保するにはNC工具での工作が不可欠。
  * NCとしてはPCBが安いし、PCBを注文する際に10cm角に収めると更に安い。
* 統計結果から、記号では「`_` 」へのアクセスには要配慮。
* 14" のノートパソコン(Thinkpad T14 Gen1)に無いキーの優先度は低いと割り切る。
  * CURSORキーは重要なので、アクセス性は重要で、片手での操作性も重要。
  * TENキーはそれほど使用上重要では無いが、組み込むなら片手での操作性に配慮重要。
  * QMKのMOUSEキーはそれほど便利では無いので、組み込む際のアクセス性は重要で無い。

QMKではタップとホールドで出力キーが違う設定できますが、タップの入力文字の連続入力がカチカチ連打だと大変な気がしていました。

実際には、一度タップ直後の再タップ時にホールドするとタップに対応する文字の長押しになるようで、OS側が連打処理してくれ使い勝手良好です。

あまり複雑なキー動作の多重化は混乱を招き使い勝手が悪くなるのですべきでは無いですが、タップとホールドを上手に使えば悪くない感じです。

## キーマップ

最初にトライしたレイヤー移動とモード変更機能のすべてを親指のキーに任せるアプローチには無理がありました。

### キーマップ osamu

そこで30%キーボード系の[ferris](https://github.com/qmk/qmk_firmware/tree/master/keyboards/ferris)のキーマップをヒントにし、「基本的に使う部分」を、左`5x3_2`キーと右`5x3_2`キーと限定し、親指はレイヤー移動のみにしたキーマップを組むのがフィジカルストレス低減によさそうです。

```
 │***│ Q │ W │ E │ R │ T │***│***│ Y │ U │ I │ O │ P │***│
 │***│lsA│lcS│laD│lgF│raG│***│***│raH│lgJ│laK│lcL│ls;│***│
 │***│ Z │ X │ C │ V │ B │***│***│ N │ M │ , │ . │ / │***│
 │***│***│***│***│Es3│Sp1│***│***│Sp2│En4│***│***│***│***│
```

ここのポイントは、人差し指〜小指のホームポジションのA行のキーに関して、通常の文字キー入力とモードキー(LSFT, LCTL, LALT, LGUI, RALT)入力を、`MT()`機能をタップとホールドで使い分け、両方ができるようにしています。このおかげで、アクセスのよい自然なポジションでタイプできます。

* 人差し指内側1つ隣: RALT (AltGr)
* 人差し指: LGUI
* 中指: LALT
* 薬指: LCTL
* 小指: LSFT

これで端のキー（特に下の角のキー）を基本使わ無くてもよくなるので、[Alice配列](https://salicylic-acid3.hatenablog.com/entry/key-layout)にしなくとも、手首へのストレスが下げられています。

一番下の４つの親指キーは、`LT()`機能を使って、４つあるTEMPORARY LAYER選択操作に加え、１２までのよくアクセスする非アルファベットキーの入力ができるようにしています。

[Retro Shift](https://docs.qmk.fm/#/feature_auto_shift?id=retro-shift)を有効にしていません。

Thumb（親指）キーで押している際に１時的に有効化する一時レイヤーは実質２つで、横3列の３０物理キーで９０のキーがカバーできます。`MT()`機能を上手につかえばThumbキーは２つでもレイヤー実現に充分です。ただ、押しやすさと、`LT()`に加え`MT()`まで使うのを避けるために、各レイヤーを左右別にして４レイヤーとして打ちやすくレスポンスよくしています。

* Thumbキーを押している側か最初に長押ししたホームポジションのA行のキーはモードキーとなります。
* Thumbキーのホームポジションを押すと、ファンクションキー・数字・キーボード端の記号のレイヤー(FL1, FL2)です。
* Thumbキーの隣のポジションを押すと、カソールキー・固定レイヤー移動キーのレイヤー(FL3, FL4)です。

上記で触れた１時レイヤー以外に、レイヤー移動後固定される固定レイヤーが4つあり、カーソル・テンキー・マウスキー・キーボード自体の設定レイヤーとなります。

上記では分かり易い様に、cgc56上の「基本的に使う部分」以外のキーの説明を省略しました。もちろんこれらも使えるようになっています。

* 従来のキーボード両端の小指で操作するキー類や最下行のキー類には、旧来のキーボードと同様の機能を与え、学習障壁を下げるようにします。(小指の操作は嫌ですので、慣れたらなるべく使いません。)
* 中心部のキー類には、狭いので一時レイヤーに押し込んだキーボード端の記号とか`F11`や`F12`、ダイナミックマクロ関連キー、カーソール関連キーのアクセスを改善するために重複配置します。

こうしてできたキーマップの詳細の最新の状況は、私の以下のQMKソースを参照:

* [cgc56:osamu](https://github.com/osamuaoki/qmk_firmware/blob/osamu1/keyboards/cgc56/keymaps/osamu/keymap.c)
* [cgg56:osamu](https://github.com/osamuaoki/qmk_firmware/blob/osamu1/keyboards/cgg56/keymaps/osamu/keymap.c)

これらは通常キーボードからの移行によく配慮されていてなかなか良い感じです。ただほとんど使わないキーがある一方で、特に片手マウスでのカーソール関連への少々アクセスが面倒でした。

### キーマップ wide

そこで、上記のデーターはそのままで、別に左右のアルファベットの間隔を更に広げ、カーソールキーに真ん中で直接アクセスできるようにし簡素化を考えました。

キーマップwideを用意しました。

* [cgc56:wide](https://github.com/osamuaoki/qmk_firmware/blob/osamu1/keyboards/cgc56/keymaps/wide/keymap.c)
* [KLE -- wide keymap](http://www.keyboard-layout-editor.com/#/gists/9d8227f51f5da1dcf325c8d2e4275bba)

![cgc56:wide BL1, FL2/FL3 in QWERTY)](/img/cgc56-wide.png)

キーマップ中の左上文字がFn1~F4の何れも押さない場合、右下文字がFn1かF2のいずれかが押された場合に入力されます。

### キーマップ mini

その後wideを使ってみて、ちょっと真ん中のキーにアクセスしにくいのが気になりました。

レイヤー数を減らしたかったので、更に簡素化したキーマップminiを用意しました。

* [cgc56:mini](https://github.com/osamuaoki/qmk_firmware/blob/osamu1/keyboards/cgc56/keymaps/mini/keymap.c)
* [KLE - mini keymap](http://www.keyboard-layout-editor.com/#/gists/a4cbabebb886c175ff4c99419e462205)

![cgc56:mini BL1, FL2/FL3 in QWERTY)](/img/cgc56-mini.png)

30%系のキーマップはとにかくホームからほとんど手が動かないので悪くないです。ただ、タップをする際にはキーを意識的に離す必要があります。

(FnレイヤーでのMODEキーが交差打鍵必須の時には、片手打ち不可の問題がありましたが、FnレイヤーもMOD-TAP化したので、その問題はほぼ解消しました。)

### キーマップ micro

その後miniを使ってみて、普通のキーボードに戻った際にリターン等で違和感がありました。

全ての指のポジション移動量を1U以下に押さえて、普通のキーボードに近いキーマップmicroを用意しました。

* [cgc56:micro](https://github.com/osamuaoki/qmk_firmware/blob/osamu1/keyboards/cgc56/keymaps/micro/keymap.c)
* [KLE - micro keymap](http://www.keyboard-layout-editor.com/#/gists/62d9362ce84fa578c4617f9501bba1cf)

![cgc56:micro BL1, FL2/FL3)](/img/cgc56-micro.png)

小指は使いますが、普通のキーボードとの親和性も良い感じのキーマップになりました。

CORNEタイプやHELIXタイプの分割キーボードとの親和性も良い感じのキーマップです。

「QWFRTY」配列は、普通のキーボードに戻った際の違和感がありメリットを感じなかったので、「QWFRTY」配列レイヤーは削除しました。


これで、メンタルストレスは総合的に一番なく、また指への物理負担もないレイアウトができたかなと思います。

## 気づいたこと

### キーキャップ

ortholinear系はシンプルなDSAのキーキャップの方がISOのキーキャップより似合う気がします。

親指のホームポジションはキーキャップの角を丸めるといい感じになっています。

### 「Shift」「Ctrl」「Alt」「Gui」キーのホームポジションキー等による兼用化

[Mod-Tap](https://docs.qmk.fm/#/mod_tap)を使うことで、「Shift」「Ctrl」「Alt」「Gui」キーのホームポジションによる兼用化がされ、無理に指を開ける指の動きがなくなりとても快適です。

さらに、右手にマウスだと「Ctrl-X」「Ctrl-C」「Ctrl-V」「ZZ」は左手操作だけでは難しかったので、Mod-Tapによる「SHIFT」「CONTROL」へのアクセスをホームポジション以外にキーボードの両端にも追加しています。（右端は、追加のレイヤー切り替えに使うのも考えられますが…）

設定されるキーに専用のMODEキーがなくなるので、その余裕をカーソールなどに使えるメリットもあります。LapTop PCのキーボードで使えるキー(TKLキーボード上のキーから、PauseとScrlLockを除く)だと、２レイヤー構成の42キーだけでアクセスを構成できます。

### キー入力と`TAPPING_TERM`

普通にキー入力する際には、キー入力を意識的に短くタップするように慣れる必要があります。最初は一生懸命押しているキーが入力されていないのか悩ましかったです。力を入れるとキーを離すのが遅くなり、結果的にホールドと判定されてました。

`TAPPING_TERM_PER_KEY`を有効にし、親指によるLAYER切り替えキーは基本`TAPPING_TERM`の75%の早めに、小指などの動きが悪い一部キーは基本`TAPPING_TERM`の200%の遅めになるように設定しました。

全体のタイミング調整は`config.h`の`TAPPING_TERM`だけでできます。`config.h`中の`TAPPING_TERM`は標準と同じ200と設定しています。

### 縦スタガート

確かに指は長さが違うので、縦スタガート設計に興味がありました。

胸の前に自然に手を持ってきて手首に一番ストレスが無いようにキーボード上に置くと、実際にキーボードを押す際の自然なホームポジションは一直線でした。

実際小指を置くキーの位置を１つ下げて試すと、すべての手の指はまっすぐ前に向くのですが手首が内側になり無理がかかり不快でした。

左右の手の間隔が30cm以下となる一体型キーボードだと手首が外側にくるので、一体型のortholinear系では縦スタガートは使いにくそうです。(「ハ」の字にすれば良いのかもしれませんが)

スプリットキーボードではキーボードの置く位置や角度が自由なので、縦スタガートでも良いのでしょうが、その導入は必須要件では無い気がします。

実際、ポピュラーな縦スタガートデザインの縦ズレ量を隣の列との差で見ると意外と少なく、最近のCorne等が隣との差がキーボードピッチの19mm単位(?)で`1/8U-1/8U-CTR-1/8U-1/4U-0`、少し古いErgodoxは1.27ピッチ(?)で`0-1-1-CTR-1-2-0`なので更に少ない感じでした。どうも`1/4U-1/2U`等という大きな縦ズレ量は少数派のようです。

### ソケットとLED配置

LEDの光が通る穴は、基本的にスイッチの端子ピンと反対側にある。

普通のCherryタイプ用とLPタイプ用の両方のソケットを装着可能にする共用PCBは、スイッチの端子ピンのソケットを反転して配置することで設計可能です。

ただしPCBの穴に埋め込まれたSK6812MINI-EのRGB光を使うPCBだと、いすれかのタイプを選ぶ必要があります。

### ダイオード

black pill等だと片側`6x3_3`キー構成のスプリットキーボードまではNKROのPCB設計がダイオード無しで可能ですが、ダイオード無しだとOLEDや他の拡張しようと思っても対応できなくなります。

### choc v1

Kailhの正規店以外では見かけなくなってきている。[遊舎工房](https://shop.yushakobo.jp/)が、意外とリーゾナブル。

LowProfileのキースイッチは、[1350](https://deskthority.net/wiki/Kailh_PG1350_series) タイプが標準で、使うならこれが好ましそう。

最近のより薄いという[1232](https://deskthority.net/wiki/Kailh_PG1232_series) タイプは、[PCBに角型の大きい穴が必要で既存のPCBと互換性が無い](https://deskthority.net/viewtopic.php?t=17340)ので要注意。

### メモリー使用量

私のキーボードは、128KBのメモリー量のAT90USB1286で余裕があるので、メモリー使用量に配慮せず各種機能を有効にしても、使用量40%程度なので特に問題ありません。

ただ、32KBしかメモリー量のないATmega32u4を使う普通のPromicroだと、メモリー使用量の制約に配慮が必要ですね。

### 今後のプラットフォーム候補

今後遊ぶには、メモリー量に余裕があるARM系のボードがよさそうです。

* [Proton-C](https://qmk.fm/proton-c/) -- オフィシャルQMKが対応(STM32F303CCT6) -- ピンコンパチが可能(?) -- 一部カットした場合
* [Blackpill](https://github.com/WeActTC/MiniSTM32F4x1) -- オフィシャルQMKが対応(STM32F411CEU6) -- ボードサイズが大きい (既存PCBに載せるのに無理がある)
* [SparkFun Pro Micro - RP2040](https://www.sparkfun.com/products/18288) -- オフィシャルQMKが未対応 (RP2040) -- ピンコンパチが可能(?)
  * [RP2040対応のQMK(非公式)](https://github.com/sekigon-gonnoc/qmk_firmware/tree/rp2040)
  * [RP2040対応のQMK(非公式)を動かす](https://scrapbox.io/self-made-kbds-ja/RP2040%E5%AF%BE%E5%BF%9C%E3%81%AEQMK(%E9%9D%9E%E5%85%AC%E5%BC%8F)%E3%82%92%E5%8B%95%E3%81%8B%E3%81%99) -- blog
  * [Keyball46組み立て日記 〜間違えてRP2040を買ったそこのあなたに〜](https://hikalium.hatenablog.jp/entry/2021/12/31/150738) -- RP2040 の PRO MICRO

Proton-C以外のARM系ボードでは、USB経由のDFUでファームウエアーを書き換えるには、「BOOT1-push」「RESET-push」「RESET-release」「BOOT1-releas」と操作するので、ボード上の２つのPUSHボタンへのアクセスが必要。代替策は、SWD経由アクセス。

### ボードサイズ

* [promicro](https://www.sparkfun.com/products/12640)
  * 12 pins/side (24 pin IC socket)
  * 17.5 x 32.5 mm (pin-gap 15.2, 2.54)
  * 7U x 12.8U (6U, 1U)
* [promicro RP2040](https://www.adafruit.com/product/5302)
  * 1.3" x 0.7" (same as promicro)
* [blackpill](https://github.com/WeActTC/MiniSTM32F4x1)
  * 20 pins/side (40 pin IC socket compat.)
  * 20.78 x 52.81 mm (pin-gap 15.22, 2.54)
  * 8.18U x 20.79U (pin-gap 6U, 1U)
* 0.91 Inch I2C 128 x 32 white OLED Display $10/5pcs
  * 1.57 x 0.38 x 0.12 inches
  * 38 x 12 mm
  * Address: 0x3C

## キーボード参考情報

片側`6X3_3`キー構成のスプリットの小さな携帯タイプが面白そうなので、当分は取り組まないけどPCBを作る際に参考となる情報をまとめました。

* 類似設計例のPCB Data のソース
  * [ferris](https://github.com/pierrechevalier83/ferris) -- 5x3+2 column staggered (on board MCU)
  * [Sweep](https://github.com/davidphilipbarr/Sweep) -- 5x3+2 column staggered
  * [microdox](https://github.com/waffle87/waffle_microdox) -- 5x3+3 LP or MX  (ソケット対応例あり)
  * [Fifi](https://github.com/raychengy/fifi_split_keeb) -- 5x3+3 column staggered
  * [Corne keyboard (crkbd)](https://github.com/foostan/crkbd) -- 6x3 +3 column staggered (helix based) (ソケット対応)
  * [Cantor Keyboard](https://github.com/diepala/cantor) -- 6x3 +3 column staggered (diodeless, black pill)
  * [Lime](https://github.com/HellSingCoder/LimeKeyboard) -- 6x3 +6 column staggered (helix based) (ソケット対応), joystick, RE
  * [let's split v2](https://github.com/climbalima/let-s-Split-v2) -- 6x4 ortholinear -- MX (ドーターボード裏付け)
  * [Lily58](https://github.com/kata0510/Lily58) -- 6x4 +5 column staggered
  * [SofleKeyboard](https://github.com/josefadamcik/SofleKeyboard) -- 6x4 +5 column staggered(ドーターボード横ズラシ)
  * [Ergo42](https://github.com/Biacco42/Ergo42) -- 7x4 ortholinear
  * [Helix](https://github.com/MakotoKurauchi/helix) -- 7x5+2 ortholinear -- RGB-LED, LP or MX (ソケット対応)
  * [SU120](https://github.com/e3w2q/su120-keyboard) -- Expandable keyboard -- RGB-LED, LP or MX （モジュラー）
  * [ENV-KB](https://github.com/Envious-Data/Env-KB) -- Full size KBD, JLCPCB examples　(ソケット対応例あり)
* 組み立てガイド
  * [How do I socket a microcontroller?](https://docs.splitkb.com/hc/en-us/articles/360011263059-How-do-I-socket-a-microcontroller-)
  * []()
* 参考基礎情報源
  * [geekhack](https://geekhack.org/)
  * [deskthority](https://deskthority.net/)
  * [Keyboard builder's digest](https://kbd.news/)
  * [Keyboard Layout Editor (KLE)](http://www.keyboard-layout-editor.com/)
  * [KLE PCB Generator](https://github.com/jeroen94704/klepcbgen)
  * [Blog: PCB techniques -- sofle-keyboard](https://josef-adamcik.cz/electronics/let-me-introduce-you-sofle-keyboard-split-keyboard-based-on-lily58.html)
  * [自作キーボード温泉街週報](https://salicylic-weekly.hatenablog.jp/) -- blog (ja)
  * [Self-Made Keyboards in Japan - Scrapbox](https://scrapbox.io/self-made-kbds-ja/)
  * [キーボード #1 Advent Calendar 2021](https://adventar.org/calendars/6246) [,, 2020](https://adventar.org/calendars/5279) [List](https://scrapbox.io/self-made-kbds-ja/%E3%82%A2%E3%83%89%E3%83%99%E3%83%B3%E3%83%88%E3%82%AB%E3%83%AC%E3%83%B3%E3%83%80%E3%83%BC)
  * [e3w2q.github.io by SU120 upstream](https://e3w2q.github.io/)
  * [Free PCBs](https://github.com/joric/jorne/wiki/Free-PCBs) -- purchase experiences
  * [Keebfol.io PCBs](https://keebfolio.netlify.app/) まとめサイト、PCB dataへのリンクあり
  * [Mechanical Keyboard and where to find them](https://github.com/help-14/mechanical-keyboard)
  * [Awesome Split Keyboards](https://github.com/diimdeep/awesome-split-keyboards)
  * [Keebio Amoeba and more PCBs](https://github.com/mtl/keyboard-pcbs)
  * [PCB design from kiibohd](https://github.com/kiibohd/pcb) -- input club
  * [Cad data: keyboard_parts.pretty](https://github.com/colemarkham/keyboard_parts.pretty)
  * [Kailh PCB socket info](https://www.kailhswitch.com/pcb-socket/)
  * [Gateron company](https://en.gateron.cn) -- real site with real dns
    * [Gateron switch](https://www.gateron.co/) -- sales trap site ??? with undisclosed dns reg

<!--

Carbon --- Ali ExpressのBest Carbon
https://www.aliexpress.com/item/32826820227.html

http://mohammedari.blogspot.com/2018/09/ali-expressbest-carbon.html
https://moryu-io-studio.hatenablog.com/entry/2018/09/10/222500
https://kou014.hateblo.jp/entry/2018/12/08/000000


  * [ほぼ週刊キーボードニュース](https://www.kbdnews.jp/)
ほぼ週刊キーボードニュース https://www.youtube.com/channel/UCyU1PAGvw_suAyI4wljHmag
SHIROGANE                  https://shirogane-lab.com/                      https://twitter.com/Yowkees トラックボール

https://www.elecrow.com/
https://www.pcbway.com/
https://jlcpcb.com/
https://www.nextpcb.com/ -- free
https://www.allpcb.com/ -- free
https://setsudando.jp/company/

Topic: [IC] RedBeard4X - Ergo 40% DIY Kit  (Read 2116 times)
MechWild Discord
IC Form
RB4X
https://geekhack.org/index.php?topic=113183.0
 single body blackpill

WS2812 DMA library with low RAM needs. Up to 16 paralel outputs and thousands of LEDs on each of them
https://github.com/hubmartin/WS2812B_STM32F4

https://biacco42.hatenablog.com/entry/2018/12/13/063814
https://biacco42.hatenablog.com/entry/2020/05/08/093000
-->

<!-- vim: se ai tw=150: -->
