---
title: ATmega32u4 (2)
date: 2020-03-29
categories:
  - DIY
  - japanese
tags:
  - avrdude
slug: ATmega32u4-2
---

今回も引き続き基本のUSB AVRの
[ATmega32u4](https://www.microchip.com/wwwproducts/en/ATmega32u4)
を中心としたAVRチップのプログラム方法とその環境に関して、
調査と情報の整理をします。

## ISP接続

Arduino系の開発ボードなら、6pinのICSPコネクターが付いているので
1pin(ポチマーク)側にAVRISP mkIIからのISP接続フラットケーブルの
[赤線側を合わせて挿せば良い](https://osamuaoki.github.io/jp/2020/02/21/atmega328p-1/)
ので簡単でした。

ATmega32u4の開発ボードの
[SparkFun Pro Micro](https://www.sparkfun.com/products/12640)、
[Teensy 2.0](https://www.pjrc.com/store/teensy.html)
や、AT90USB1286の開発ボードの
[Teensy 2.0++](https://www.pjrc.com/store/teensypp.html)
などやそのコンパチ品はICSPコネクターが付いていないので
「直結接続」が必要です。

「直結接続」のために、以下の写真のように片側にクリップ、
片側にオスやメスのデュポンコネクターが付いたワイヤーを準備
しました。(AVR系をAVRUSP mkIIでISP書き換えするにはオスの
デュポンコネクター版だけで充分ですが、将来ARM系のSTM32F等を
ST-LINK/V2等で書き換えするのにはメスのデュポンコネクター版が
あると便利そうなので両方準備してみました。)

![直結用クリップワイヤー](/img/clip-wire.jpg)

左右逆にしないことが大事なので、接続関係をここにまとめます。

ISP接続フラットケーブルのコネクター
（赤線側上です。コネクター穴側から見た「左図」が大事！)

```
                  RED SIDE 赤線側
BTM VIEW コネクター穴側                 TOP VIEW
VCC  2  1 MISO                        MISO 1  2 VCC
MOSI 4  3 SCK                         SCK  3  4 MOSI
GND  6  5 RST                         RST  5  6 GND

(こっちがメイン)
Looking from                          Looking from the
the hole side                         back of the connector hole
```

以下、開発ボードの端子はチップが載っている表側(TOP側)から、
USBコネクターを「左」に置き見て、「半時計回り」(CCW)で
「0スタート」(逆方向は-1スタート、角からスタート、重複命名有り)
で位置表記し、ISPコネクターの端子は赤線側を上にして、
コネクター穴側から見て位置表記することとします。

[Teensy 2.0開発ボード](https://www.pjrc.com/teensy/pinout.html)の場合(所有)：

* ボード下0: GND
* ボード下2: SCLK --> 3 コネクター右側中央
* ボード下3: MOSI --> 4 コネクター左側中央(VCC/GND間)
* ボード下4: MISO --> 1 コネクター右側上(赤線側)
* ...
* ボード右2: VCC  --> 2 コネクター左側上(赤線側)
* ボード右3(CTR): GND  --> 6 コネクター左側下
* ボード右4: RST  --> 5 コネクター右側下
* ボード上-1(Last): VCC

[Teensy 2.0++開発ボード](https://www.pjrc.com/teensy/pinout.html)の場合(所有)：

* ボード下0: GND
* ボード右1: VCC  --> 2 コネクター左側上(赤線側)
* ボード右2(CTR): GND  --> 6 コネクター左側下
* ボード右3: RST  --> 5 コネクター右側下
* ...
* ボード上-7: SCLK --> 3 コネクター右側中央
* ボード上-6: MOSI --> 4 コネクター左側中央(VCC/GND間)
* ボード上-5: MISO --> 1 コネクター右側上(赤線側)
* ボード上-1(Last): VCC

参考:[Pro Micro開発ボード](https://learn.sparkfun.com/tutorials/pro-micro--fio-v3-hookup-guide/hardware-overview-pro-micro)の場合(非所有、推定)：

* ボード上1: MOSI --> 4 コネクター左側中央(VCC/GND間)
* ボード上2: MISO --> 1 コネクター右側上(赤線側)
* ボード上3: SCLK --> 3 コネクター右側中央
* ...
* ボード上-4: VCC  --> 2 コネクター左側上(赤線側)
* ボード上-3: RST  --> 5 コネクター右側下
* ボード上-2: GND  --> 6 コネクター左側下

以下では、外部電源接続無しでISP接続で読み書きできるよう
にした[改造AVRISP mkII](/jp/2020/02/27/avrisp-mod-j/)を
使っています。

## teensy 2.0 compat.

ブレッドボードに挿し一部クリップ接続で検査！

![ISP接続 ブレッドボード+クリップ](/img/isp-clip.jpg)

```
$ sudo avrdude -c avrisp2 -P usb -p m32u4 -v
....
avrdude: stk500v2_command(): command failed
avrdude: stk500v2_program_enable(): bad AVRISPmkII connection status: Unknown status 0x00
avrdude: initialization failed, rc=-1
         Double check connections and try again, or use -F to override
         this check.


avrdude done.  Thank you.
```

うーん、前に何か悪いことしてチップを壊したかな？ちょっと不安。
ブレッドボードは接触によく不安があるし、挟むタイプのクリップは
挟む線が太いと外れやすくここも接触に不安がありました。

そこで不安を解消するように、開発ボードがPIN付き基板なので
メス+オスのデュポンコネクターのワイヤーでしっかり接続して、
再チャレンジしました。

![ISP接続 ワイヤー](/img/isp-wire.jpg)

```
$ sudo avrdude -c avrisp2 -P usb -p m32u4 -v -F
...

avrdude: Device signature = 0x1e9587 (probably m32u4)
avrdude: safemode: lfuse reads as 5F
avrdude: safemode: hfuse reads as D9
avrdude: safemode: efuse reads as C5

avrdude: safemode: lfuse reads as 5F
avrdude: safemode: hfuse reads as D9
avrdude: safemode: efuse reads as C5
avrdude: safemode: Fuses OK (E:C5, H:D9, L:5F)

avrdude done.  Thank you.
```

まずは良し良しでした。とにかく素人電子工作では接触不良に要注意です。
さらに`-U lock:r:-:h`をつけると、0xC5コードが出て文字化けした後、
0xffと表示されます。

* CKDIV8
* SUT1 (16K CK)
* SPIEN
* BOOTSZ1, BOOTSZ0 (ブート領域2KW=4KB)
* HWBE
* BODLEVEL1 (BODが2.2V)

ちなみに、正規品はブート領域が4KBではなく、512Bで、BOD設定も違います。

* LFUSE: 0x5F
* HFUSE: 0xDF (ブート領域512B)
* EFUSE: 0xF4 (BODが2.4V)
* LOCK:  0xCC

## Teensy 2.0++ compat.

こっちはピン無し裸ボードなので、上記の直結用クリップワイヤーを
使ってつなぎました。

```
$ sudo avrdude -c avrisp2 -P usb -p usb1286 -v -F
.....
avrdude: AVR device initialized and ready to accept instructions

Reading | ################################################## | 100% 0.00s

avrdude: Device signature = 0x1e9782 (probably usb1287)
avrdude: safemode: lfuse reads as 4F
avrdude: safemode: hfuse reads as DD
avrdude: safemode: efuse reads as F5

avrdude: safemode: lfuse reads as 4F
avrdude: safemode: hfuse reads as DD
avrdude: safemode: efuse reads as F5
avrdude: safemode: Fuses OK (E:F5, H:DD, L:4F)
```

うまくはつながっているようですが、チョット変です。上記だと；

* CKDIV8
* SUT1, SUT0 (1K CK)
* SPIEN
* BOOTSZ0 (1KW=2KB)
* HWBE
* BODLEVEL1

正直、AtmelのDFUやLUFAのDFUが約4KBあるのに、なぜこの開発ボードの
チップは2KBのブート領域なのかはチョット不思議です。安売りしていた
のはこれが原因かな？他の人がどうしているのかを調べると:
[Bootloaders for AT90USB1286](http://blog.lincomatic.com/?p=548)
```
 $ avrdude -c usbtiny -p at90usb1286 -U lfuse:w:0xde:m -U hfuse:w:0xdb:m -U efuse:w:0xf0:m
```
* LFUSE: 0xDE Unset CKDIV8, SUT 258 CK
* HFUSE: 0xDB (ブート領域4KB=2KW)
* EFUSE: 0xF0 (BODがV)4.3V

純正Atmel DFUは4KBより少し大きいのも気になります。

ちなみに以下は参考です。

* [AT90usb1286のデーターシート等](https://www.microchip.com/wwwproducts/en/AT90USB1286)
* [Working with AT90USB1286 bootloader](https://www.avrfreaks.net/forum/working-at90usb1286-bootloader)
* [Teensy reset](https://forum.pjrc.com/threads/34108-Teensy-reset)


## AVRへのプログラム導入

Fuse関連で困ったらは、
[fusecalc](https://eleccelerator.com/fusecalc/fusecalc.php)
や
[Pro Micro クローン ATmega32U4を使う](https://make.kosakalab.com/make/electronic-work/aitendo-pm32u4/)
や
[AVR fuse](https://github.com/osamuaoki/avrdude-friend/wiki/AVR-fuse)
を見ましょう。

<!-- vim: se ai tw=79: -->

