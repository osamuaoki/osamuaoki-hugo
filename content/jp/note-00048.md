---
title: QMK (5) -- JOYSTICKサポート
date: 2022-04-02
categories:
  - iot
  - japanese
tags:
  - qmk
slug: joystick
---

## 状況

AVRで作ったQMKキーボードでは、[タップとホールドを上手く利用した使いやすいキーマップ](/jp/2022/03/15/home-mt/)ができました。

[ARMで作ったQMKキーボード](/jp/2022/02/07/blackpill-1/)にこれを移植するとともに、追加ハードのアナログJOYSTICKをマウスの機能を提供するデバイスとして有効利用しました。

## JOYSTICKデバイスの追加とMCUの機能設定

「JOYSTICK」という言葉に引かれて、よく分からないままマニュアルの[「Hardware Features」の「Joystick」](https://docs.qmk.fm/#/feature_joystick)をフォローして、ゲーム用のコントローラーとしての「JOYSTICK」デバイスを導入しました。

ここで、ARM系のハードの初期化のカスタマイズ法を学びました。ARMではOS立ち上げコードがチップ機能の初期化をしているようです。マクロを定義することで、コンパイル時に設定が導入されます。ある意味AVRのfuseの感じです。

ChibiOSは、デフォルトの`halconf.h`や`mcuconf.h`を提供しているので、デフォルトでは無効化されたADCを使う等の場合には、設定をオーバーライド変更する必要がありました。
最初に、`platforms/chibios/boards/keyboard-config-templates/`内のファイルを、プロジェクトフォルダー内にコピーしたファイルをベースに、オーバーライド変更のみを設定します。
デフォルト値は`#include_next "... .h"`で読み込みます。(この辺の仕組みがが分かる前には、コンパイラーエラーに苦しみました。)

ゲーム用のコントローラーとしての「JOYSTICK」デバイスの動作検証は、[Gamepad Tester](https://gamepad-tester.com/)
でしました。この環境での安定動作には、`config.h`に以下の追加が必要でした。([参考情報源](https://www.reddit.com/r/ErgoMechKeyboards/comments/r6btqm/qmk_joystick_with_stm32f411_blackpill/))

```
#define JOYSTICK_AXES_RESOLUTION 8
#define USB_POLLING_INTERVAL_MS 4
```
ゲーム用のコントローラーとしてのJOYSTICKデバイスを提供するソース

* [cgg56:minijoy](https://github.com/osamuaoki/qmk_firmware/blob/osamu1/keyboards/cgg56/keymaps/minijoy/keymap.c)

ゲーム用のコントローラーにマウスの機能を提供する設定は、OSの環境設定でできなくはないです。ただこれでは本末転倒です。
ストレートにマウスの機能自体を直接提供すること目的なので、これはここまでにします。


## JOYSTICKのハードによるマウス機能の提供

JOYSTICKのハードによるマウス機能の提供には、マニュアルの[「Hardware Features」の「Pointing Device」](https://docs.qmk.fm/#/feature_pointing_device)をフォローします。

* [cgg56:mini](https://github.com/osamuaoki/qmk_firmware/blob/osamu1/keyboards/cgg56/keymaps/mini/keymap.c)

Mouse keyよりは快適に動いていますが、ThnkpadのTrackpointが得意でない私には決して使いやすいとは言えない状態でした。本物のMouseは使いやすい。

## 気づいたこと

QMKでは意外と多くのハードを利用してマウス機能の提供ができるようです。また、マウスの中身はほぼ似たデバイスのようです。
キーボードだけでなく、ポテンシオメーター、ロータリーエンコーダー、オプティカルセンサー等で作るポインティングデバイスででも遊べそうです。色んな事をみんなしていますね。

* [ダイソーの300円ワイヤレスマウスを分解して回路図と部品表を書いてみた話 (2019-03-14)](https://note.com/tomorrow56/n/n48285316a3ae)
    * [「どうせ100均だろ？」って軽い気持ちで分解したら、 ガジェットの進化に驚いた！](https://persol-tech-s.co.jp/i-engineer/technology/gadgetdisassembly)
* [トラックボールを作ってみた【試作編】](https://qiita.com/qzi00173/items/a59cd74d9c6aa33c3e3f)
* [アナログスティックを使ってcrkbdをマウスとしても使えるようにした話 2](https://note.com/mariotto1001/n/n5bfaf9b144bf)
* [自作トラックポイント1](https://qiita.com/kirin123kirin/items/04a6d4d9657489538e1a#%E3%83%88%E3%83%A9%E3%83%83%E3%82%AF%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88%E3%82%92%E5%88%86%E5%89%B2%E3%82%AD%E3%83%BC%E3%83%9C%E3%83%BC%E3%83%89%E3%81%AE%E5%8F%B3%E5%81%B4%E3%81%AB%E5%8F%96%E3%82%8A%E4%BB%98%E3%81%91%E3%81%9F%E3%81%84)

<!-- vim: se ai tw=150: -->


